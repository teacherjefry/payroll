<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neerada Payroll System v2026 (Unified)</title>
    <link id="app-favicon" rel="icon" type="image/png" href="">
    <link id="app-apple-touch-icon" rel="apple-touch-icon" href="">
    
    <!-- Google Fonts: Combined -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Noto+Sans+Lao:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- GLOBAL & THEME VARIABLES --- */
        :root {
            --primary-900: #1e3a8a;
            --primary-800: #1e40af;
            --primary-700: #1d4ed8;
            --primary-600: #2563eb;
            --primary-100: #dbeafe;
            --primary-50: #eff6ff;
        }

        /* Base Font Settings */
        body { font-family: 'Inter', 'Noto Sans Lao', sans-serif; }
        .font-hero { font-family: 'Playfair Display', serif; }
        .font-cursive { font-family: 'Dancing Script', cursive; }

        /* --- LANDING PAGE STYLES --- */
        body.view-landing {
            /* Professional Accounting Background */
            background-image: url('https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            overflow-x: hidden;
        }

        /* General Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.65); /* Lower opacity as requested */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        /* Specific Glass for Hero Title */
        .glass-hero {
            background: rgba(255, 255, 255, 0.65); /* Lower opacity */
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px 0 rgba(0, 0, 0, 0.1);
            border-radius: 2rem;
            padding: 3rem;
            display: inline-block;
        }

        /* Feature Card Aesthetic */
        .feature-card {
            background: rgba(255, 255, 255, 0.65); /* Lower opacity as requested */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 1.5rem;
            transition: all 0.4s ease;
        }
        .feature-card:hover {
            transform: translateY(-5px) scale(1.03);
            background: rgba(255, 255, 255, 0.85);
        }
        /* Glow effects for cards */
        .glow-blue:hover { box-shadow: 0 10px 40px -10px rgba(59, 130, 246, 0.4); }
        .glow-green:hover { box-shadow: 0 10px 40px -10px rgba(16, 185, 129, 0.4); }
        .glow-purple:hover { box-shadow: 0 10px 40px -10px rgba(139, 92, 246, 0.4); }
        .glow-orange:hover { box-shadow: 0 10px 40px -10px rgba(249, 115, 22, 0.4); }
        .glow-rose:hover { box-shadow: 0 10px 40px -10px rgba(244, 63, 94, 0.4); }
        .glow-indigo:hover { box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.4); }

        .glass-footer {
            background: linear-gradient(90deg, rgba(255,255,255,0.85) 0%, rgba(240,253,250,0.85) 100%);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.8);
        }

        .hover-3d { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .hover-3d:hover { transform: translateY(-5px); }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }

        /* Aesthetic Text Gradients */
        .text-gradient-hero { 
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .text-gradient-primary {
            background: linear-gradient(135deg, #1d4ed8 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- APP SPECIFIC STYLES --- */
        body.view-app { background-color: #f3f4f6; background-image: none; height: 100vh; overflow: hidden; }
        
        /* Theme Overrides */
        body.theme-default { --primary-900: #1e3a8a; --primary-800: #1e40af; --primary-700: #1d4ed8; --primary-600: #2563eb; --primary-100: #dbeafe; --primary-50: #eff6ff; }
        
        /* Color Mappings */
        .bg-blue-900 { background-color: var(--primary-900) !important; }
        .bg-blue-800 { background-color: var(--primary-800) !important; }
        .bg-blue-700 { background-color: var(--primary-700) !important; }
        .bg-blue-600 { background-color: var(--primary-600) !important; }
        .bg-blue-100 { background-color: var(--primary-100) !important; }
        .bg-blue-50 { background-color: var(--primary-50) !important; }
        .text-blue-900 { color: var(--primary-900) !important; }
        .text-blue-800 { color: var(--primary-800) !important; }
        .text-blue-700 { color: var(--primary-700) !important; }
        .text-blue-600 { color: var(--primary-600) !important; }
        .text-blue-100 { color: var(--primary-100) !important; }
        .border-blue-100 { border-color: var(--primary-100) !important; }
        .border-blue-200 { border-color: #bfdbfe !important; }

        /* Custom Scrollbar */
        #employee-list::-webkit-scrollbar, #editor-content::-webkit-scrollbar, #dept-tree::-webkit-scrollbar { width: 6px; }
        #employee-list::-webkit-scrollbar-thumb, #editor-content::-webkit-scrollbar-thumb, #dept-tree::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

        /* Editor Highlights */
        .field-highlight-1 input { background-color: #f0fdf4 !important; border-color: #22c55e !important; font-weight: 800 !important; color: #15803d !important; }
        .field-highlight-2 input { background-color: #fff7ed !important; border-color: #f97316 !important; font-weight: 800 !important; color: #c2410c !important; }

        /* Lock Screen */
        #system-lock-overlay {
            background: rgba(15, 23, 42, 0.85); /* Slightly transparent */
            backdrop-filter: blur(25px);
        }

        /* Print Styles */
        @media print {
            @page { size: auto; margin: 0mm; } 
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            #landing-view, #welcome-modal, #system-lock-overlay, #global-archive-modal { display: none !important; }
            body > *:not(#app-view) { display: none !important; }
            #app-view { display: block !important; height: auto !important; overflow: visible !important; }
            header, aside, #editor-content, #empty-state, .no-print, button, select, input:not([type="hidden"]), #bulk-action-management, .max-w-6xl > div:first-child { display: none !important; }
            #app-content, #view-payroll, #payroll-workspace, #editor-area { display: block !important; height: auto !important; width: 100% !important; margin: 0 !important; padding: 0 !important; background: white !important; position: static !important; overflow: visible !important; }
            #preview-pane { display: block !important; position: relative !important; width: 100% !important; margin: 0 !important; padding: 15mm !important; border: none !important; box-shadow: none !important; background: white !important; visibility: visible !important; opacity: 1 !important; font-size: 12pt !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            #preview-pane * { visibility: visible !important; opacity: 1 !important; }
            .bg-blue-900 { background-color: #1e3a8a !important; color: white !important; }
            .bg-blue-50 { background-color: #eff6ff !important; }
            .bg-red-50 { background-color: #fef2f2 !important; }
            .bg-green-100 { background-color: #dcfce7 !important; }
            .bg-orange-100 { background-color: #ffedd5 !important; }
            .bg-purple-100 { background-color: #f3e8ff !important; }
            .bg-yellow-50 { background-color: #fefce8 !important; }
            .text-red-600 { color: #dc2626 !important; }
            .text-blue-900 { color: #1e3a8a !important; }
            .text-white { color: white !important; }
            .print-info-container { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 15px !important; margin-bottom: 20px !important; background-color: #eff6ff !important; padding: 15px !important; border-radius: 8px !important; border: 1px solid #dbeafe !important; }
            #net-pay-block { color: white !important; }
        }
    </style>
</head>
<body class="view-landing theme-default">

    <!-- ================= LANDING PAGE SECTION ================= -->
    <div id="landing-view" class="min-h-screen flex flex-col relative z-10">
        <!-- Navigation -->
        <nav class="fixed w-full z-50 transition-all duration-300 p-4">
            <div class="max-w-7xl mx-auto glass rounded-full px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div id="landing-logo-container" class="bg-blue-900/10 p-2 rounded-full"><i data-lucide="hexagon" class="w-6 h-6 text-blue-900"></i></div>
                    <img id="landing-custom-logo" src="" class="w-10 h-10 object-cover rounded-full hidden" />
                    <span class="font-hero text-xl font-bold tracking-wide text-blue-900">Neerada</span>
                </div>
                <button onclick="window.launchApp()" class="bg-blue-900 hover:bg-blue-800 text-white px-5 py-2 rounded-full text-sm font-semibold transition-transform hover:scale-105 shadow-lg">Launch System</button>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="relative pt-32 pb-16 lg:pt-48 lg:pb-24 px-6 text-center">
            <div class="max-w-5xl mx-auto">
                <!-- Glassmorphism Background for Hero Title (No Animation) -->
                <div class="glass-hero mb-10">
                    <h1 class="font-hero text-5xl md:text-7xl lg:text-8xl font-black mb-4 leading-tight">
                        <span class="text-slate-800">Neerada Payroll</span><br>
                        <span class="text-gradient-primary italic">System</span>
                    </h1>
                    <p class="text-lg md:text-xl text-slate-600 font-medium font-sans">
                        Precision. Elegance. Efficiency.
                    </p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <button onclick="window.launchApp()" class="group relative px-8 py-4 bg-gradient-to-r from-blue-900 to-blue-800 text-white rounded-xl font-bold text-lg overflow-hidden shadow-2xl hover-3d flex items-center gap-3">
                        <span>Enter Dashboard</span>
                        <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                    <a href="#features" class="px-8 py-4 glass text-slate-900 rounded-xl font-bold text-lg hover:bg-white/90 transition-all shadow-md">
                        Explore Features
                    </a>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section id="features" class="py-16 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Smaller Aesthetic Cards -->
                    <div class="feature-card p-6 glow-blue group cursor-default">
                        <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center mb-4 group-hover:bg-blue-600 transition-colors duration-500">
                            <i data-lucide="globe" class="w-6 h-6 text-blue-600 group-hover:text-white transition-colors"></i>
                        </div>
                        <h3 class="font-hero text-xl font-bold text-slate-800 mb-2">Multi-Currency</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Automated LAK & USD handling with real-time rate conversion.</p>
                    </div>

                    <div class="feature-card p-6 glow-green group cursor-default">
                        <div class="w-12 h-12 bg-green-50 rounded-xl flex items-center justify-center mb-4 group-hover:bg-green-600 transition-colors duration-500">
                            <i data-lucide="zap" class="w-6 h-6 text-green-600 group-hover:text-white transition-colors"></i>
                        </div>
                        <h3 class="font-hero text-xl font-bold text-slate-800 mb-2">Instant Math</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Tax, social security, and overtime computed instantly.</p>
                    </div>

                    <div class="feature-card p-6 glow-purple group cursor-default">
                        <div class="w-12 h-12 bg-purple-50 rounded-xl flex items-center justify-center mb-4 group-hover:bg-purple-600 transition-colors duration-500">
                            <i data-lucide="file-check" class="w-6 h-6 text-purple-600 group-hover:text-white transition-colors"></i>
                        </div>
                        <h3 class="font-hero text-xl font-bold text-slate-800 mb-2">Smart Payslips</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Bilingual, print-ready payslips tailored for distribution.</p>
                    </div>

                    <div class="feature-card p-6 glow-orange group cursor-default">
                        <div class="w-12 h-12 bg-orange-50 rounded-xl flex items-center justify-center mb-4 group-hover:bg-orange-600 transition-colors duration-500">
                            <i data-lucide="credit-card" class="w-6 h-6 text-orange-600 group-hover:text-white transition-colors"></i>
                        </div>
                        <h3 class="font-hero text-xl font-bold text-slate-800 mb-2">Loan Tracker</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Integrated tracking for active balances and history.</p>
                    </div>

                    <div class="feature-card p-6 glow-rose group cursor-default">
                        <div class="w-12 h-12 bg-rose-50 rounded-xl flex items-center justify-center mb-4 group-hover:bg-rose-600 transition-colors duration-500">
                            <i data-lucide="shield-check" class="w-6 h-6 text-rose-600 group-hover:text-white transition-colors"></i>
                        </div>
                        <h3 class="font-hero text-xl font-bold text-slate-800 mb-2">Local Security</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Offline-capable browser storage keeps data private.</p>
                    </div>

                    <div class="feature-card p-6 glow-indigo group cursor-default">
                        <div class="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center mb-4 group-hover:bg-indigo-600 transition-colors duration-500">
                            <i data-lucide="layout-grid" class="w-6 h-6 text-indigo-600 group-hover:text-white transition-colors"></i>
                        </div>
                        <h3 class="font-hero text-xl font-bold text-slate-800 mb-2">Flexible Structures</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">Custom rules for Academic, GS, and English departments.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Professional Insight Section -->
        <section class="py-16 px-6 bg-slate-900/5 backdrop-blur-sm">
            <div class="max-w-6xl mx-auto glass rounded-2xl p-8 lg:p-12">
                <div class="flex flex-col md:flex-row items-center gap-12">
                    <div class="w-full md:w-1/2">
                        <img src="https://images.unsplash.com/photo-1554224154-26032ffc0d07?ixlib=rb-1.2.1&auto=format&fit=crop&w=1352&q=80" alt="Financial Planning" class="rounded-xl shadow-2xl w-full h-64 object-cover transform rotate-1 hover:rotate-0 transition-transform duration-500">
                    </div>
                    <div class="w-full md:w-1/2 text-center md:text-left">
                        <i data-lucide="quote" class="w-12 h-12 text-blue-900/20 mb-4 inline-block"></i>
                        <blockquote class="font-hero text-3xl text-slate-800 font-bold leading-relaxed mb-6">
                            "Precision is not just an act, it is the soul of financial integrity."
                        </blockquote>
                        <p class="text-slate-600 font-medium">Streamlining operations for a brighter educational future.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Compact Footer -->
        <footer class="mt-auto glass-footer text-slate-600 py-6 px-6">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="font-hero text-lg font-bold text-blue-900">Neerada Payroll</span>
                </div>
                <p class="text-xs font-medium">© 2026 Neerada School Payroll System. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- System Lock Overlay (Moved outside views for global visibility) -->
    <div id="system-lock-overlay" class="fixed inset-0 z-[200] hidden flex-col items-center justify-center text-white">
        <div class="glass p-12 rounded-[3rem] text-center max-w-lg w-full mx-4 shadow-2xl">
            <div class="mb-6 inline-flex p-5 bg-white/20 rounded-full animate-float">
                <i data-lucide="lock" class="w-10 h-10 text-white drop-shadow-md"></i>
            </div>
            <h1 class="text-4xl font-hero font-bold mb-6 text-white drop-shadow-lg tracking-wide">System Locked</h1>
            <p id="lock-message" class="text-2xl text-white font-cursive mb-10 drop-shadow-md leading-relaxed"></p>
            
            <button onclick="window.tryUnlock()" class="group bg-white text-blue-900 px-8 py-3 rounded-full font-bold shadow-xl hover:scale-105 transition-transform flex items-center justify-center gap-2 mx-auto">
                <i data-lucide="key" class="w-4 h-4 text-blue-600"></i>
                Unlock System
            </button>
        </div>
    </div>

    <!-- ================= APP VIEW SECTION ================= -->
    <div id="app-view" class="hidden flex flex-col h-full relative z-0">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-blue-900 text-white flex items-center justify-center z-50 transition-opacity duration-500">
            <div class="text-center animate-pulse">
                <h1 class="text-2xl font-bold">Neerada Payroll</h1>
                <p class="text-sm opacity-75 mt-2">Loading Unified System v2026...</p>
            </div>
        </div>

        <!-- App Content -->
        <div id="app-content" class="flex flex-col h-full hidden">
            <!-- Header / Nav -->
            <header class="bg-blue-900 text-white p-3 md:p-4 shadow-md flex justify-between items-center z-20 shrink-0">
                <div class="flex items-center gap-4">
                    <button id="mobile-back-btn" onclick="window.goBack()" class="lg:hidden p-1.5 bg-blue-800 rounded-full hover:bg-blue-700 hidden">
                        <i data-lucide="chevron-left" class="w-5 h-5 text-white"></i>
                    </button>
                    <!-- Default Hexagon removed as requested -->
                    <img id="header-custom-logo" src="" class="w-8 h-8 object-cover rounded-full hidden md:block" />
                    <div>
                        <h1 class="font-bold text-lg leading-tight">Neerada Payroll</h1>
                        <p class="text-[10px] text-blue-300 hidden md:block">Unified System v2026</p>
                    </div>
                    
                    <div class="hidden md:flex bg-blue-800 rounded-lg p-1 ml-6">
                        <button id="tab-dashboard" onclick="window.switchView('dashboard')" class="px-4 py-1.5 text-sm font-medium rounded-md bg-blue-800 text-white transition-colors">Dashboard</button>
                        <button id="tab-payroll" onclick="window.switchView('payroll')" class="px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors">Staff Manager</button>
                        <button id="tab-config" onclick="window.switchView('config')" class="px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors">Payslip Data</button>
                        <button id="tab-ot-loans" onclick="window.switchView('ot-loans')" class="px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors">OT & Loans</button>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="window.goToLanding()" class="flex items-center gap-1 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-xs font-medium transition-colors border border-white/10" title="Exit to Home">
                        <i data-lucide="home" class="w-3.5 h-3.5"></i> <span class="hidden md:inline">Home</span>
                    </button>
                    <button onclick="window.openSettings()" class="p-2 rounded-full hover:bg-blue-800 transition-colors" title="Settings">
                        <i data-lucide="settings" class="w-5 h-5 text-blue-100"></i>
                    </button>
                    <div class="md:hidden flex gap-2">
                          <button onclick="window.switchView('dashboard')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700 text-white">Dash</button>
                          <button onclick="window.switchView('payroll')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700 text-white">Staff</button>
                          <button onclick="window.switchView('ot-loans')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700 text-white">OT/Loans</button>
                    </div>
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-blue-800 rounded-lg text-xs font-medium border border-blue-700 hidden md:flex text-white">
                        <i data-lucide="calendar" class="w-3 h-3"></i>
                        <span id="date-display">...</span>
                    </div>
                </div>
            </header>

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="flex-1 overflow-y-auto p-4 lg:p-8">
                <div class="max-w-6xl mx-auto space-y-8">
                    <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Financial Overview</h2>
                            <p class="text-gray-500 text-sm">Combined Monthly Payroll Track</p>
                        </div>
                        <div class="flex gap-2 items-center">
                            <div class="flex bg-white rounded-md shadow-sm border border-gray-200">
                                <select id="filter-year" onchange="window.updateDashboardStats()" class="bg-transparent text-sm font-medium text-gray-700 p-2 outline-none border-r border-gray-200"></select>
                                <select id="filter-month" onchange="window.updateDashboardStats()" class="bg-transparent text-sm font-medium text-gray-700 p-2 outline-none">
                                    <option value="All">All Months</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                            <!-- Swapped Save Monthly Run with For the Bank -->
                            <button onclick="window.downloadBankReport()" class="flex items-center justify-center gap-2 bg-yellow-500 text-white px-4 py-2 rounded shadow hover:bg-yellow-600 transition text-sm font-medium">
                                <i data-lucide="building" class="w-4 h-4"></i> For the Bank
                            </button>
                            <button onclick="window.downloadCSVReport()" class="flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition text-sm font-medium ml-2" title="Download CSV Report">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Export CSV
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-2">
                            <p class="text-xs font-bold text-gray-400 uppercase">Total Paid (LAK)</p>
                            <p id="stat-total-paid-lak" class="text-2xl font-mono font-bold text-blue-900 mt-2 whitespace-nowrap overflow-x-auto">₭ 0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-2">
                            <p class="text-xs font-bold text-gray-400 uppercase">Total Paid (USD)</p>
                            <p id="stat-total-paid-usd" class="text-2xl font-mono font-bold text-green-700 mt-2 whitespace-nowrap overflow-x-auto">$0.00</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-1">
                            <p class="text-xs font-bold text-gray-400 uppercase">Staff Count</p>
                            <p id="stat-employees" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-1">
                            <p class="text-xs font-bold text-gray-400 uppercase">Latest Record</p>
                            <div class="flex flex-col mt-2">
                                <span id="stat-last-month" class="text-sm font-bold text-gray-800">No Data</span>
                                <span id="stat-last-amount" class="text-xs text-gray-500">---</span>
                            </div>
                        </div>
                    </div>

                    <div id="dept-breakdown" class="mt-8"></div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-8">
                        <div class="p-4 border-b border-gray-100 bg-gray-50">
                            <h3 class="font-bold text-gray-700">Payment History Logs</h3>
                        </div>
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 w-full text-gray-500 text-xs uppercase font-medium">
                                <tr>
                                    <th class="px-4 py-3">Period</th>
                                    <th class="px-4 py-3">Staff</th>
                                    <th class="px-4 py-3 text-right">Total LAK</th>
                                    <th class="px-4 py-3 text-right">Total USD</th>
                                    <th class="px-4 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-list" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CONFIGURATION VIEW -->
            <div id="view-config" class="flex-1 overflow-y-auto p-4 lg:p-8 hidden bg-gray-50">
                <div class="max-w-4xl mx-auto">
                    
                    <!-- BULK IMPORT SECTION -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                        <div class="mb-4">
                            <h2 class="text-lg font-bold text-gray-800">Bulk Payslip Data Import</h2>
                            <p class="text-sm text-gray-500">Download a pre-filled template for a department, enter the monthly amounts, and upload to update payroll records. <span class="text-orange-600 font-bold">Note: Templates utilize Employee Name for matching. Please do not modify names in the CSV.</span></p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Step 1: Select Period -->
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <div class="flex items-center gap-2 mb-3 text-green-700 font-bold text-sm">
                                    <span class="w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-xs">1</span> Select Template Period
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Month</label>
                                        <select id="bulk-import-month" class="w-full border rounded p-2 text-sm bg-white"></select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Year</label>
                                        <select id="bulk-import-year" class="w-full border rounded p-2 text-sm bg-white"></select>
                                    </div>
                                    <p class="text-[10px] text-gray-400">This date will be pre-filled in the CSV.</p>
                                </div>
                            </div>

                            <!-- Step 2: Download -->
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <div class="flex items-center gap-2 mb-3 text-green-700 font-bold text-sm">
                                    <span class="w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-xs">2</span> Download Template
                                </div>
                                <div class="space-y-2">
                                    <button onclick="window.downloadTemplate('Kindergarten')" class="w-full flex justify-between items-center px-3 py-2 bg-white border rounded text-sm text-gray-700 hover:bg-gray-50">
                                        <span>Kindergarten</span> <i data-lucide="download" class="w-4 h-4 text-gray-400"></i>
                                    </button>
                                    <button onclick="window.downloadTemplate('Primary')" class="w-full flex justify-between items-center px-3 py-2 bg-white border rounded text-sm text-gray-700 hover:bg-gray-50">
                                        <span>Primary</span> <i data-lucide="download" class="w-4 h-4 text-gray-400"></i>
                                    </button>
                                    <button onclick="window.downloadTemplate('Secondary')" class="w-full flex justify-between items-center px-3 py-2 bg-white border rounded text-sm text-gray-700 hover:bg-gray-50">
                                        <span>Secondary</span> <i data-lucide="download" class="w-4 h-4 text-gray-400"></i>
                                    </button>
                                    <div class="relative">
                                        <select id="download-other-dept" onchange="if(this.value) { window.downloadTemplate(this.value); this.value=''; }" class="w-full appearance-none px-3 py-2 bg-white border rounded text-sm text-gray-700 hover:bg-gray-50 cursor-pointer">
                                            <option value="">Download Other Dept...</option>
                                            <!-- Populated dynamically -->
                                        </select>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-3 top-2.5 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Upload -->
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <div class="flex items-center gap-2 mb-3 text-green-700 font-bold text-sm">
                                    <span class="w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-xs">3</span> Upload Data
                                </div>
                                <div class="flex flex-col items-center justify-center h-32 border-2 border-dashed border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition-colors">
                                    <button onclick="document.getElementById('bulk-payslip-csv').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-sm">
                                        <i data-lucide="upload" class="w-4 h-4"></i> Bulk Upload CSV
                                    </button>
                                    <p class="text-[10px] text-gray-400 mt-2 text-center px-4">System will update records based on Name, Month, and Year in the file.</p>
                                    <input type="file" id="bulk-payslip-csv" accept=".csv" class="hidden" onchange="window.handleBulkCSVPayslipUpload(this)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden mb-8">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center text-blue-900">
                            <h2 class="text-xl font-bold flex items-center gap-3">
                                <i data-lucide="file-spreadsheet" class="w-6 h-6 text-yellow-600"></i> Payroll Structure Management
                            </h2>
                            <button onclick="window.addNewDept()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-indigo-700 flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> New Dept
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100 flex items-end gap-2">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-blue-800 uppercase mb-2">Select Department to Edit</label>
                                    <select id="config-dept-select" onchange="window.loadDeptConfig()" class="w-full p-2 border rounded bg-white text-sm"></select>
                                </div>
                                <button onclick="window.renameDept()" class="bg-blue-50 text-blue-700 border border-blue-200 p-2 rounded hover:bg-blue-100 transition-colors" title="Rename Department">
                                    <i data-lucide="edit-3" class="w-5 h-5"></i>
                                </button>
                                <button onclick="window.deleteDept()" class="bg-red-50 text-red-600 border border-red-200 p-2 rounded hover:bg-red-100 transition-colors" title="Delete Department">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>

                            <div id="config-editor-area" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>

                            <div class="mt-8 flex justify-end gap-3 pt-6 border-t border-gray-100">
                                <button onclick="window.saveDeptConfig()" class="bg-blue-600 text-white px-8 py-2.5 rounded hover:bg-blue-700 flex items-center gap-2 font-bold shadow-md transition-all">
                                    <i data-lucide="save" class="w-5 h-5"></i> Apply Changes Globally
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OT & LOANS VIEW -->
            <div id="view-ot-loans" class="flex-1 overflow-y-auto p-1 hidden bg-gray-50">
                <div class="w-full mx-auto">
                    <div class="flex flex-col lg:flex-row gap-6 h-full">
                        <!-- Left Sidebar: Selectors -->
                        <div class="w-full lg:w-1/3 space-y-4 p-4">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h2 class="font-bold text-blue-900 mb-4 flex items-center gap-2"><i data-lucide="filter" class="w-4 h-4"></i> Selection</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Target Month</label>
                                        <div class="flex gap-2">
                                            <select id="otl-month" class="w-full p-2 border rounded text-sm bg-gray-50" onchange="window.refreshOTLoansView()"></select>
                                            <select id="otl-year" class="w-1/3 p-2 border rounded text-sm bg-gray-50" onchange="window.refreshOTLoansView()"></select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Select Staff</label>
                                        <input type="text" id="otl-search" placeholder="Search name..." class="w-full p-2 border rounded text-sm mb-2" onkeyup="window.filterOTLStaff()">
                                        <div id="otl-staff-list" class="h-64 overflow-y-auto border rounded bg-white divide-y divide-gray-100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Main: Editors -->
                        <div class="w-full lg:w-2/3 space-y-6 p-4">
                            
                            <!-- OVERVIEW DASHBOARD (New Record Page) -->
                            <div id="otl-overview" class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-xl font-bold text-gray-800">Records & Reports</h2>
                                    <span id="otl-report-period" class="text-sm font-medium bg-blue-100 text-blue-800 px-3 py-1 rounded-full"></span>
                                </div>

                                <!-- Loan Record Summary -->
                                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div class="p-4 border-b border-gray-100 bg-orange-50 flex justify-between items-center">
                                        <h3 id="active-loans-header" class="font-bold text-orange-800 flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4"></i> Active Loan Records</h3>
                                        <div class="flex gap-2">
                                            <button onclick="window.bulkCopyLoanPayments()" class="p-1.5 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-full transition-colors flex items-center gap-1 text-[10px] font-bold shadow-sm border border-blue-200">
                                                <i data-lucide="repeat" class="w-3.5 h-3.5"></i> Copy Prev Month
                                            </button>
                                            <button onclick="window.openGlobalArchives()" class="p-1.5 bg-orange-100 text-orange-700 hover:bg-orange-200 rounded-full transition-colors flex items-center gap-1 text-[10px] font-bold shadow-sm border border-orange-200">
                                                <i data-lucide="folder-clock" class="w-3.5 h-3.5"></i> All Archives
                                            </button>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                                                <tr>
                                                    <th class="px-4 py-3">Employee</th>
                                                    <th class="px-4 py-3">Loan Desc</th>
                                                    <th class="px-4 py-3 text-center">Date Loan</th>
                                                    <th class="px-4 py-3 text-center">Start Pay</th>
                                                    <th class="px-4 py-3 text-right">Total Loan</th>
                                                    <th class="px-4 py-3 text-right">Total Paid</th>
                                                    <th class="px-4 py-3 text-center"># Paid</th>
                                                    <th class="px-4 py-3 text-right">This Month</th>
                                                    <th class="px-4 py-3 text-right">Balance</th>
                                                </tr>
                                            </thead>
                                            <tbody id="otl-report-loans" class="divide-y divide-gray-100"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- OT Record Summary -->
                                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div class="p-4 border-b border-gray-100 bg-blue-50">
                                        <h3 class="font-bold text-blue-800 flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> Overtime Records (Selected Month)</h3>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                                                <tr>
                                                    <th class="px-4 py-3">Employee</th>
                                                    <th class="px-4 py-3">Department</th>
                                                    <th class="px-4 py-3 text-right">Hours</th>
                                                    <th class="px-4 py-3 text-right">Rate</th>
                                                    <th class="px-4 py-3 text-right">Total Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="otl-report-ot" class="divide-y divide-gray-100"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- OT Management -->
                            <div id="ot-management-card" class="bg-white rounded-xl shadow-sm border border-gray-200 hidden">
                                <div class="p-4 border-b border-gray-100 bg-blue-50 flex justify-between items-center">
                                    <h3 class="font-bold text-blue-800 flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> Overtime Management</h3>
                                    <div class="flex items-center gap-2">
                                        <span id="otl-selected-name" class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full"></span>
                                        <button onclick="window.closeOTLEditor()" class="text-xs text-gray-500 hover:text-gray-700 underline">Close</button>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div id="ot-inputs-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- Dynamic Inputs -->
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button onclick="window.saveOTDetails()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-blue-700 flex items-center gap-2">
                                            <i data-lucide="save" class="w-4 h-4"></i> Update OT in Payslip
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Loan Management -->
                            <div id="loan-management-card" class="bg-white rounded-xl shadow-sm border border-gray-200 hidden">
                                <div class="p-4 border-b border-gray-100 bg-orange-50 flex justify-between items-center">
                                    <h3 class="font-bold text-orange-800 flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4"></i> Loan Monitor</h3>
                                    <button onclick="window.printLoanStatement()" class="text-xs flex items-center gap-1 bg-white border border-orange-200 text-orange-700 px-2 py-1 rounded hover:bg-orange-100">
                                        <i data-lucide="printer" class="w-3 h-3"></i> Print Statement
                                    </button>
                                </div>
                                <div class="p-6 space-y-6">
                                    <!-- Active Loans Table -->
                                    <div>
                                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Active Loans</h4>
                                        <div class="overflow-x-auto border rounded-lg">
                                            <table class="w-full text-sm text-left">
                                                <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                                                    <tr>
                                                        <th class="px-3 py-2">Type</th>
                                                        <th class="px-3 py-2 text-center">Date</th>
                                                        <th class="px-3 py-2 text-center">Start</th>
                                                        <th class="px-3 py-2 text-right">Total</th>
                                                        <th class="px-3 py-2 text-right">Paid</th>
                                                        <th class="px-3 py-2 text-center">#</th>
                                                        <th class="px-3 py-2 text-right">Balance</th>
                                                        <th class="px-3 py-2 text-center">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="otl-loans-list" class="divide-y divide-gray-100"></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Add/Edit Loan Form -->
                                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 relative">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 id="loan-form-title" class="text-xs font-bold text-gray-700 uppercase">Add New Loan</h4>
                                            <button id="btn-cancel-loan" onclick="window.cancelLoanEdit()" class="text-xs text-red-500 underline hidden">Cancel Edit</button>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                            <input id="new-loan-desc" type="text" placeholder="Loan Description (e.g. Car Loan)" class="border rounded p-2 text-sm">
                                            <input id="new-loan-amount" type="number" placeholder="Total Amount (LAK)" class="border rounded p-2 text-sm">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                                            <div><label class="text-[10px] font-bold text-gray-500 uppercase">Date of Loan</label><input id="new-loan-date" type="date" class="w-full border rounded p-2 text-sm"></div>
                                            <div><label class="text-[10px] font-bold text-gray-500 uppercase">Start Payment</label><input id="new-loan-start" type="date" class="w-full border rounded p-2 text-sm"></div>
                                            <button id="btn-save-loan" onclick="window.saveLoanRecord()" class="bg-gray-800 text-white px-3 py-2 rounded text-sm font-bold hover:bg-gray-900 h-[38px]">Add Loan</button>
                                        </div>
                                    </div>

                                    <!-- Repayment for Current Month -->
                                    <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                        <h4 class="text-xs font-bold text-green-800 uppercase mb-3">Record Repayment for <span id="otl-repay-month"></span></h4>
                                        <p class="text-xs text-gray-600 mb-3">This amount will be deducted from the payslip and applied to loan balances.</p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
                                            <div>
                                                <label class="block text-[10px] font-bold text-gray-500 mb-1">Repayment Amount (LAK)</label>
                                                <input id="loan-repay-amount" type="text" oninput="window.formatCurrencyInput(this)" class="w-full border rounded p-2 text-sm font-mono text-red-600" placeholder="0">
                                            </div>
                                            <button onclick="window.saveLoanPayment()" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-green-700 flex items-center justify-center gap-2">
                                                <i data-lucide="check-circle" class="w-4 h-4"></i> Apply Deduction
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="otl-empty-state" class="text-center py-12 text-gray-400 hidden">
                                <i data-lucide="user-check" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                                <p>Select a staff member to manage OT & Loans.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAYROLL MANAGER VIEW -->
            <div id="view-payroll" class="flex-1 overflow-hidden relative hidden">
                <div class="flex h-full flex-col lg:flex-row">
                    <aside class="hidden xl:flex w-64 bg-gray-50 border-r border-gray-200 flex-col z-10 h-full overflow-y-auto">
                        <div class="p-4 border-b border-gray-100 bg-gray-100 sticky top-0">
                                    <h2 class="font-bold text-gray-700 text-xs uppercase tracking-wider">Departments</h2>
                        </div>
                        <div id="dept-tree" class="p-2 space-y-1"></div>
                    </aside>

                    <aside id="sidebar" class="w-full lg:w-72 bg-white border-r border-gray-200 flex flex-col z-10 h-[35vh] lg:h-full">
                        <div class="p-4 border-b border-gray-100 bg-white flex flex-col gap-3 shrink-0">
                            <div class="flex justify-between items-center">
                                <h2 class="font-semibold text-gray-700 flex items-center gap-2">
                                    <i data-lucide="users" class="w-4 h-4"></i> Staff List
                                </h2>
                                <div class="flex gap-1">
                                    <button onclick="window.exportDepartmentPayslipData()" title="PAYSLIP DATA" class="p-1 hover:bg-blue-100 rounded text-purple-600 transition-colors">
                                        <i data-lucide="table" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="window.downloadCSVTemplate()" title="Download CSV Template" class="p-1 hover:bg-blue-100 rounded text-green-600 transition-colors">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="window.triggerImport()" title="Import Staff CSV" class="p-1 hover:bg-blue-100 rounded text-blue-600 transition-colors">
                                        <i data-lucide="upload" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="window.deleteAllPhotos()" title="Delete All Photos" class="p-1 hover:bg-red-100 rounded text-red-600 transition-colors">
                                        <i data-lucide="image-off" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="window.openStaffModal(null)" title="Add Staff" class="p-1 hover:bg-blue-100 rounded text-blue-600 transition-colors">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <input type="file" id="staff-csv-input" accept=".csv" class="hidden" onchange="window.handleStaffCSV(this)">
                            </div>
                        </div>

                        <div id="bulk-action-management" class="p-4 border-b border-gray-100 bg-white shadow-inner shrink-0">
                            <h3 class="text-xs font-bold text-gray-600 mb-3 flex items-center gap-2 uppercase tracking-tight">
                                <i data-lucide="database" class="w-3.5 h-3.5 text-indigo-600"></i> Filtered Data Actions
                            </h3>
                            <div class="text-[9px] text-gray-500 mb-3 uppercase font-semibold">Targets: <span id="current-filter-label" class="text-blue-800 font-bold">All Staff</span></div>

                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="window.bulkSavePayroll()" class="col-span-2 flex items-center justify-center gap-2 py-2 bg-indigo-600 text-white font-bold rounded shadow-sm hover:bg-indigo-700 transition text-xs">
                                    <i data-lucide="save-all" class="w-3.5 h-3.5"></i> Save All to History
                                </button>
                                <button onclick="window.bulkResetPayroll()" class="flex items-center justify-center gap-2 py-2 bg-yellow-50 text-yellow-700 border border-yellow-200 font-bold rounded shadow-sm hover:bg-yellow-100 transition text-[10px]">
                                    <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset Data
                                </button>
                                <button id="delete-dept-button" onclick="window.deleteAllEmployeesInFilter()" class="flex items-center justify-center gap-2 py-2 bg-red-50 text-red-700 border border-red-200 font-bold rounded shadow-sm hover:bg-red-100 transition text-[10px]">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Delete All
                                </button>
                            </div>
                        </div>

                        <div id="filter-status" class="px-4 py-2 bg-blue-50 text-xs text-blue-800 border-b border-blue-100 hidden flex justify-between items-center">
                            <span id="filter-label" class="font-medium truncate">All Staff</span>
                            <button onclick="window.clearFilter()" class="text-blue-500 hover:text-blue-700"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <div id="employee-list" class="flex-1 overflow-y-auto p-2"></div>
                    </aside>

                    <main id="payroll-workspace" class="flex-1 overflow-y-auto bg-gray-100 p-4 lg:p-6 block">
                        <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400 space-y-4">
                            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
                                <i data-lucide="briefcase" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <p>Select an employee to view details.</p>
                        </div>

                        <div id="editor-area" class="w-full max-w-6xl mx-auto flex flex-col xl:flex-row gap-6 hidden">
                            <div class="w-full xl:w-1/3 space-y-4 no-print flex flex-col h-full">
                                <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 mb-4 flex items-center justify-between">
                                    <div class="text-xs font-bold text-blue-800 uppercase tracking-wide">Period</div>
                                    <div class="flex gap-2">
                                        <select id="editor-month" onchange="window.loadPeriodData()" class="text-xs border rounded p-1 bg-white outline-none"></select>
                                        <select id="editor-year" onchange="window.loadPeriodData()" class="text-xs border rounded p-1 bg-white outline-none"></select>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4">
                                    <div class="grid grid-cols-1 gap-2">
                                        <button onclick="window.viewEmployeeHistory()" class="flex items-center justify-center gap-2 w-full py-2 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-100 text-sm font-medium mb-1">
                                            <i data-lucide="bar-chart-2" class="w-4 h-4"></i> View History Dashboard
                                        </button>
                                        <button onclick="window.editCurrentStaff()" class="flex items-center justify-center gap-2 w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium">
                                            <i data-lucide="user-cog" class="w-4 h-4"></i> Edit Staff Details
                                        </button>
                                        <button onclick="window.loadPreviousMonthData()" class="flex items-center justify-center gap-2 w-full py-2 bg-orange-50 text-orange-700 border border-orange-200 rounded hover:bg-orange-100 text-sm font-medium">
                                            <i data-lucide="copy" class="w-4 h-4"></i> Copy from Previous Month
                                        </button>
                                        <button onclick="window.saveEmployeePayrollData()" class="flex items-center justify-center gap-2 w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium">
                                            <i data-lucide="save" class="w-4 h-4"></i> Save Month Data
                                        </button>
                                        <button onclick="window.resetCurrentPayroll()" class="flex items-center justify-center gap-2 w-full py-2 bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100 text-sm">
                                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset Data
                                        </button>
                                        <div class="grid grid-cols-3 gap-2 mt-1">
                                            <button onclick="window.openPrintSettings()" title="Print Settings" class="flex items-center justify-center py-2 bg-gray-800 text-white rounded hover:bg-gray-900 text-sm"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                            <button onclick="window.sendEmail()" title="Email Payslip" class="flex items-center justify-center py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"><i data-lucide="mail" class="w-4 h-4"></i></button>
                                            <button onclick="window.sendWhatsApp()" title="WhatsApp" class="flex items-center justify-center py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm"><i data-lucide="message-circle" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div id="editor-content" class="flex-1 overflow-y-auto"></div>
                            </div>

                            <!-- Live Preview -->
                            <div id="preview-pane" class="w-full xl:w-2/3 bg-white p-6 md:p-8 rounded shadow-lg border border-gray-200 text-xs md:text-sm">
                                <div class="border-b-2 border-blue-900 pb-4 mb-4 flex justify-between items-start">
                                    <div class="flex items-center gap-4">
                                        <img id="prev-school-logo" class="h-16 w-auto hidden object-contain">
                                        <div>
                                            <h1 class="text-xl md:text-2xl font-bold text-blue-900 uppercase tracking-widest">Neerada School</h1>
                                            <p class="text-gray-500 text-xs mt-1">Excellence in Education</p>
                                            <div class="flex items-center gap-2 text-gray-400 text-[10px] mt-1">
                                                <i data-lucide="building" class="w-3 h-3"></i>
                                                <span id="prev-campus">Campus</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <img id="prev-profile-pic" class="h-16 w-16 object-cover rounded-full border mb-2 hidden bg-gray-100">
                                        <div class="text-right">
                                            <h2 class="text-lg font-semibold text-gray-800">PAYSLIP</h2>
                                            <p class="text-xs text-gray-600">Date: <span id="prev-date" class="font-bold"></span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mb-6 bg-blue-50 p-3 rounded-lg print-info-container">
                                    <div><p class="text-[10px] text-gray-500 uppercase">Employee Name</p><p id="prev-name" class="text-gray-800 text-sm font-bold">---</p></div>
                                    <div><p class="text-[10px] text-gray-500 uppercase">Position</p><p id="prev-pos" class="font-bold text-gray-800 text-sm">---</p></div>
                                    <div><p class="text-[10px] text-gray-500 uppercase">Department</p><p id="prev-dept" class="font-bold text-gray-800 text-sm">---</p></div>
                                    <div><p class="text-[10px] text-gray-500 uppercase">Employee ID</p><p id="prev-id" class="text-gray-800 font-mono text-sm">---</p></div>
                                </div>
                                
                                <div id="preview-content"></div>
                                <div id="print-footer" class="mt-8 text-center text-[10px] text-gray-400">
                                    <p>Computer-generated. No signature required.</p>
                                    <p>© <span id="copyright-year"></span> Neerada School Payroll System</p>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>

        <!-- APP MODALS -->
        <!-- Add Modal -->
        <div id="add-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <h2 id="modal-title" class="text-xl font-bold mb-4 text-blue-900">Staff Details</h2>
                <form id="add-form" onsubmit="window.saveEmployee(event)" class="space-y-4">
                    <input type="hidden" name="id" id="form-id">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-16 h-16 rounded-full bg-gray-100 border flex items-center justify-center overflow-hidden">
                            <img id="form-preview-pic" class="w-full h-full object-cover hidden">
                            <i data-lucide="user" id="form-default-icon" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <div class="flex-1 space-y-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Profile Photo</label>
                            <input type="file" id="form-profile-pic" accept="image/*" onchange="window.handleProfileUpload(this)" class="w-full text-xs text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <button type="button" id="delete-modal-photo-btn" onclick="window.clearModalPhoto()" class="text-[10px] text-red-500 hover:text-red-700 underline font-medium mt-1 hidden">Remove Photo</button>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label><input required name="name" id="form-name" type="text" class="w-full border rounded p-2 text-sm"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Campus</label>
                            <select name="campus" id="form-campus" class="w-full border rounded p-2 text-sm bg-gray-50" onchange="window.filterModalDepts()">
                                <option>Sibounheuang</option>
                                <option>Chommany</option>
                                <option>General Services</option>
                            </select>
                        </div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Department</label><select name="department" id="form-department" onchange="window.toggleBankFields()" class="w-full border rounded p-2 text-sm bg-white"></select></div>
                    </div>
                    <!-- Combined Position and Bank Name Row -->
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Position</label><input required name="position" id="form-position" type="text" class="w-full border rounded p-2 text-sm"></div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bank Account Name</label>
                            <input name="bankAccountName" id="form-bank-name" oninput="window.checkBankName(this)" type="text" placeholder="e.g. MR SOULIVANH" class="w-full border rounded p-2 text-sm">
                            <p id="bank-name-warning" class="text-[10px] text-red-500 font-bold mt-1 hidden">⚠️ Required for Bank Transfer</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">LAK Bank Account</label><input name="bankLak" id="form-bank-lak" type="text" class="w-full border rounded p-2 text-sm"></div>
                        <div id="bank-usd-container" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-1">USD Bank Account</label><input name="bankUsd" id="form-bank-usd" type="text" class="w-full border rounded p-2 text-sm"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label><input name="email" id="form-email" type="email" class="w-full border rounded p-2 text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">WhatsApp</label><input name="whatsapp" id="form-whatsapp" type="text" class="w-full border rounded p-2 text-sm"></div>
                    <div class="pt-4 flex gap-3"><button type="button" onclick="window.closeModal()" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button><button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium">Save Staff</button></div>
                </form>
            </div>
        </div>

        <!-- NEW RATE CALCULATOR MODAL -->
        <div id="rate-calc-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[200] p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-blue-900 flex items-center gap-2"><i data-lucide="calculator" class="w-5 h-5"></i> Rate Calculator</h2>
                    <button onclick="document.getElementById('rate-calc-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Buying Rate</label>
                            <input type="number" id="calc-buy" class="w-full border rounded p-2 text-sm" placeholder="0" oninput="window.calculateRateAvg()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selling Rate</label>
                            <input type="number" id="calc-sell" class="w-full border rounded p-2 text-sm" placeholder="0" oninput="window.calculateRateAvg()">
                        </div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded text-center border border-blue-100">
                        <p class="text-xs text-blue-800 uppercase font-bold mb-1">Calculated Average</p>
                        <p id="calc-result" class="text-2xl font-mono font-bold text-blue-900">0</p>
                    </div>
                    <button onclick="window.applyCalculatedRate()" class="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 transition-colors shadow-md text-sm">
                        Apply Rate to All English Staff
                    </button>
                </div>

                <div class="border-t pt-4">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> Rate History (English Dept)</h3>
                    <div id="calc-history-list" class="max-h-40 overflow-y-auto space-y-1 text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-100">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto relative">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">Settings</h2><button onclick="window.closeSettings()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                <div class="space-y-6">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">App Theme</label><select id="theme-select" onchange="window.setTheme(this.value)" class="w-full border rounded p-2 text-sm bg-white"><option value="default">Default Blue</option><option value="emerald">Emerald Green</option><option value="rose">Rose Red</option><option value="slate">Slate Dark</option><option value="violet">Violet</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">School Logo</label><input type="file" accept="image/*" onchange="window.handleLogoUpload(this)" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Admin Lock Code</label><input type="password" id="admin-code-input" class="w-full border rounded p-2 text-sm" placeholder="Enter new code" onchange="window.updateAdminCode(this.value)"></div>
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-2">Bulk Payroll Tools</label>
                        <div class="flex gap-2 mb-2">
                            <select id="bulk-month" class="w-1/2 p-1 text-xs border rounded bg-white"></select>
                            <select id="bulk-year" class="w-1/2 p-1 text-xs border rounded bg-white"></select>
                        </div>
                        <div class="space-y-2">
                            <button onclick="window.bulkCopyPrevious()" class="w-full py-2 bg-orange-100 text-orange-700 border border-orange-200 rounded text-xs font-bold hover:bg-orange-200 flex items-center justify-center gap-2 transition-colors"><i data-lucide="copy" class="w-3 h-3"></i> Copy Previous Month (All)</button>
                            <button onclick="window.bulkSaveMonthData()" class="w-full py-2 bg-green-100 text-green-700 border border-green-200 rounded text-xs font-bold hover:bg-green-200 flex items-center justify-center gap-2 transition-colors"><i data-lucide="save" class="w-3 h-3"></i> Save Month Data (All)</button>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2 leading-tight">"Save Month Data" creates records using Department Defaults for everyone in the selected month.</p>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Data Management</label><div class="grid grid-cols-1 gap-2"><button onclick="window.exportData()" class="flex items-center justify-center gap-2 w-full py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded hover:bg-blue-100 text-sm font-medium"><i data-lucide="download" class="w-4 h-4"></i> Export Backup</button><button onclick="document.getElementById('import-file').click()" class="flex items-center justify-center gap-2 w-full py-2 bg-gray-50 text-gray-700 border border-gray-200 rounded hover:bg-gray-100 text-sm font-medium"><i data-lucide="upload" class="w-4 h-4"></i> Import Restore</button><input type="file" id="import-file" accept=".json" class="hidden" onchange="window.importData(this)"></div></div>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <p class="text-[10px] text-gray-400 text-center flex-1">Neerada GS Payroll System v2026</p>
                    <!-- Developer Secret Icon -->
                    <button onclick="window.handleDevSecret()" class="text-gray-200 hover:text-gray-400 p-1 transition-colors" title="System Lock"><i data-lucide="lock" class="w-3 h-3"></i></button>
                </div>
            </div>
        </div>

        <!-- History Modals -->
        <div id="otl-history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[150] p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col">
                <div class="p-6 border-b border-gray-100 flex justify-between items-start shrink-0">
                    <div><h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="clipboard-list" class="w-5 h-5 text-blue-600"></i><span id="otl-hist-name">Employee Record</span></h2><p class="text-sm text-gray-500">Loan & Overtime History</p></div>
                    <div class="flex items-center gap-2">
                         <button onclick="window.goToManageFromHistory()" class="bg-blue-600 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow hover:bg-blue-700 flex items-center gap-1">
                             <span>Manage & Deduct</span> <i data-lucide="arrow-right" class="w-3 h-3"></i>
                         </button>
                         <button onclick="document.getElementById('otl-history-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto space-y-6">
                    <div><h3 class="text-xs font-bold text-gray-500 uppercase mb-2 border-b pb-1">Current Active Loans</h3><div class="overflow-x-auto border rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-500 text-xs uppercase"><tr><th class="px-3 py-2">Description</th><th class="px-3 py-2 text-center">Added</th><th class="px-3 py-2 text-right">Total</th><th class="px-3 py-2 text-right">Paid</th><th class="px-3 py-2 text-right">Balance</th></tr></thead><tbody id="otl-hist-active-loans" class="divide-y divide-gray-100"></tbody></table></div></div>
                    <div><h3 class="text-xs font-bold text-gray-500 uppercase mb-2 border-b pb-1">Archived Loans (Completed)</h3><div class="overflow-x-auto border rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-500 text-xs uppercase"><tr><th class="px-3 py-2">Description</th><th class="px-3 py-2 text-center">Date Added</th><th class="px-3 py-2 text-right">Total</th></tr></thead><tbody id="otl-hist-archived-loans" class="divide-y divide-gray-100"></tbody></table></div></div>
                    <div><h3 class="text-xs font-bold text-gray-500 uppercase mb-2 border-b pb-1">Loan Payment History</h3><div class="overflow-x-auto border rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-green-50 text-green-800 text-xs uppercase"><tr><th class="px-3 py-2">Month</th><th class="px-3 py-2 text-right">Payment Amount (LAK)</th><th class="px-3 py-2 text-center"></th></tr></thead><tbody id="otl-hist-payments" class="divide-y divide-gray-100"></tbody></table></div></div>
                    <div><h3 class="text-xs font-bold text-gray-500 uppercase mb-2 border-b pb-1">Overtime History</h3><div class="overflow-x-auto border rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-blue-50 text-blue-800 text-xs uppercase"><tr><th class="px-3 py-2">Month</th><th class="px-3 py-2 text-right">Details</th><th class="px-3 py-2 text-right">Total OT Amount</th></tr></thead><tbody id="otl-hist-ot" class="divide-y divide-gray-100"></tbody></table></div></div>
                </div>
            </div>
        </div>

        <!-- Global Archive Modal -->
        <div id="global-archive-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[150] p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col">
                <div class="p-6 border-b border-gray-100 flex justify-between items-start shrink-0 bg-orange-50">
                    <div>
                        <h2 class="text-xl font-bold text-orange-800 flex items-center gap-2"><i data-lucide="archive" class="w-5 h-5"></i> Global Archived Loans</h2>
                        <p class="text-sm text-orange-600">History of all completed loans across the organization</p>
                    </div>
                    <button onclick="document.getElementById('global-archive-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">Employee</th>
                                    <th class="px-4 py-3">Department</th>
                                    <th class="px-4 py-3">Description</th>
                                    <th class="px-4 py-3 text-center">Date Added</th>
                                    <th class="px-4 py-3 text-right">Total Amount</th>
                                    <th class="px-4 py-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="global-archive-list" class="divide-y divide-gray-100">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="employee-history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col">
                <div class="p-6 border-b border-gray-100 flex justify-between items-start shrink-0">
                    <div><h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-600"></i><span id="hist-emp-name">Employee History</span></h2><p id="hist-emp-dept" class="text-sm text-gray-500">Department</p></div>
                    <button onclick="document.getElementById('employee-history-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><p class="text-xs font-bold text-blue-800 uppercase">Total Earned (LAK)</p><p id="hist-total-lak" class="text-2xl font-mono font-bold text-blue-900 mt-1">₭ 0</p></div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-100"><p class="text-xs font-bold text-green-800 uppercase">Total Earned (USD)</p><p id="hist-total-usd" class="text-2xl font-mono font-bold text-green-900 mt-1">$0.00</p></div>
                    </div>
                    <div id="hist-rows" class="overflow-y-auto max-h-[50vh] flex-1 space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Print & Save Modals -->
        <div id="print-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[150] p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Print Settings</h2>
                <div class="space-y-6">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Orientation</label><div class="flex gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="print-orient" value="portrait" checked class="text-blue-600"><span class="text-sm">Portrait</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="print-orient" value="landscape" class="text-blue-600"><span class="text-sm">Landscape</span></label></div></div>
                    <div><div class="flex justify-between items-center mb-2"><label class="block text-xs font-bold text-gray-500 uppercase">Page Scale</label><span id="scale-val" class="text-xs font-mono font-bold text-blue-600">100%</span></div><input type="range" id="print-scale" min="50" max="150" value="100" class="w-full accent-blue-600" oninput="document.getElementById('scale-val').innerText = this.value + '%'"></div>
                    <div class="pt-2 flex gap-3"><button onclick="window.closePrintSettings()" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button><button onclick="window.executePrint()" class="flex-1 py-2 bg-gray-800 text-white rounded hover:bg-gray-900 font-medium flex items-center justify-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i> Print Now</button></div>
                </div>
            </div>
        </div>

        <div id="save-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <h2 class="text-xl font-bold mb-4 text-blue-900">Save Payroll Run</h2>
                <form onsubmit="window.savePayrollHistory(event)" class="space-y-4">
                    <select id="save-month" class="w-full border rounded p-2 text-sm bg-white"></select>
                    <input id="save-year" type="number" class="w-full border rounded p-2 text-sm" value="2026">
                    <button type="submit" class="w-full py-2 bg-green-600 text-white rounded font-medium mt-4">Save & Close</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- System Lock Overlay (Moved outside views for global visibility) -->
    <div id="system-lock-overlay" class="fixed inset-0 z-[200] hidden flex-col items-center justify-center text-white">
        <div class="glass p-12 rounded-[3rem] text-center max-w-lg w-full mx-4 shadow-2xl">
            <div class="mb-6 inline-flex p-5 bg-white/20 rounded-full animate-float">
                <i data-lucide="lock" class="w-10 h-10 text-white drop-shadow-md"></i>
            </div>
            <h1 class="text-4xl font-hero font-bold mb-6 text-white drop-shadow-lg tracking-wide">System Locked</h1>
            <p id="lock-message" class="text-2xl text-white font-cursive mb-10 drop-shadow-md leading-relaxed"></p>
            
            <button onclick="window.tryUnlock()" class="group bg-white text-blue-900 px-8 py-3 rounded-full font-bold shadow-xl hover:scale-105 transition-transform flex items-center justify-center gap-2 mx-auto">
                <i data-lucide="key" class="w-4 h-4 text-blue-600"></i>
                Unlock System
            </button>
        </div>
    </div>

    <!-- ================= LOGIC SECTION ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ==========================================
        // PASTE YOUR FIREBASE CONFIG HERE
        // ==========================================
        const firebaseConfig = {
             // Replace with your actual config from Firebase Console > Project Settings
             apiKey: "YOUR_API_KEY",
             authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
             projectId: "YOUR_PROJECT_ID",
             storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
             messagingSenderId: "YOUR_SENDER_ID",
             appId: "YOUR_APP_ID"
        };
        // ==========================================

        let dbFirestore;
        let auth;
        let adminCode = "0000"; // Default, will be overwritten by Firebase

        // Attempt to initialize Firebase
        try {
            // Check if user has updated placeholder
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                const app = initializeApp(firebaseConfig);
                dbFirestore = getFirestore(app);
                auth = getAuth(app);
                
                // Auth anonymously to read settings
                signInAnonymously(auth).then(() => {
                    console.log("Firebase Connected");
                    loadGlobalSettings();
                }).catch((error) => {
                    console.error("Firebase Auth Error:", error);
                });
            } else {
                console.log("Firebase config missing. Using local defaults.");
            }
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        async function loadGlobalSettings() {
            if (!dbFirestore) return;
            try {
                const docRef = doc(dbFirestore, "app_settings", "main");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.adminCode) adminCode = data.adminCode;
                    if (data.logo) {
                        localStorage.setItem('neerada_school_logo', data.logo);
                        window.updateLogoDOM(data.logo);
                    }
                    if (data.theme) window.setTheme(data.theme, false); // false = don't save back to DB loop
                }
            } catch (e) {
                console.error("Error loading settings:", e);
            }
        }

        window.saveGlobalSettings = async (updates) => {
            if (!dbFirestore) return;
            try {
                const docRef = doc(dbFirestore, "app_settings", "main");
                await setDoc(docRef, updates, { merge: true });
            } catch (e) {
                console.error("Error saving settings:", e);
            }
        };

        window.updateAdminCode = (val) => {
            if(val && val.length >= 4) {
                adminCode = val;
                window.saveGlobalSettings({ adminCode: val });
                alert("Admin code updated.");
            }
        };

        // Expose functions globally for legacy script access
        window.dbFirestore = dbFirestore;
    </script>

    <script>
        // --- VIEW MANAGEMENT ---
        window.launchApp = function(skipAnim = false) {
            // Check Lock
            if (localStorage.getItem('neerada_locked') === 'true') {
                window.showLockScreen();
                return;
            }

            document.getElementById('landing-view').classList.add('hidden');
            document.body.classList.remove('view-landing');
            const appView = document.getElementById('app-view');
            appView.classList.remove('hidden');
            document.body.classList.add('view-app');
            
            // Set persistence flag
            localStorage.setItem('neerada_current_view', 'app');
            
            // Switch to saved tab or default to dashboard
            const savedTab = localStorage.getItem('neerada_active_tab') || 'dashboard';
            window.switchView(savedTab);
            
            if (!window.appInitialized) {
                initApp();
                window.appInitialized = true;
            }
        };

        window.goToLanding = function() {
            document.getElementById('app-view').classList.add('hidden');
            document.body.classList.remove('view-app');
            
            document.getElementById('landing-view').classList.remove('hidden');
            document.body.classList.add('view-landing');
            
            localStorage.setItem('neerada_current_view', 'landing');
            localStorage.removeItem('neerada_active_tab'); // Reset on logout
        };
        
        // --- DEVELOPER SECRET LOGIC ---
        window.handleDevSecret = function() {
            const code = prompt("Enter Admin Code:");
            // Check against dynamic adminCode (defaults to "0000" but updated via Firebase)
            // Note: Since main script doesn't see module scope, we rely on the input field value or default
            // Actually, best way is to read the input field in settings if loaded, or use default
            const storedCode = document.getElementById('admin-code-input').value || "0000";
            
            if (code === storedCode) {
                const msg = prompt("SYSTEM LOCK: Enter a maintenance message to display. (Leave empty to cancel)");
                if (msg !== null && msg.trim() !== "") {
                    localStorage.setItem('neerada_locked', 'true');
                    localStorage.setItem('neerada_lock_msg', msg);
                    window.showLockScreen();
                }
            } else {
                alert("Access Denied");
            }
        };

        window.showLockScreen = function() {
            const overlay = document.getElementById('system-lock-overlay');
            const msgEl = document.getElementById('lock-message');
            
            msgEl.innerText = localStorage.getItem('neerada_lock_msg') || "System Unavailable";
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            // Hide main views to ensure lock screen is dominant
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('app-view').classList.add('hidden');
        };

        window.tryUnlock = function() {
            const code = prompt("Enter Unlock Code:");
            const storedCode = document.getElementById('admin-code-input').value || "0000";

            if (code === storedCode) {
                localStorage.removeItem('neerada_locked');
                localStorage.removeItem('neerada_lock_msg');
                document.getElementById('system-lock-overlay').classList.add('hidden');
                document.getElementById('system-lock-overlay').classList.remove('flex');
                
                // Return to landing
                window.goToLanding();
            } else {
                alert("Incorrect Code");
            }
        };

        // --- APP LOGIC (Previously in neerada_payroll.html) ---
        const DB_NAME = 'NeeradaCombinedDB_v1';
        const DB_VERSION = 1;
        const STORE_EMPLOYEES = 'employees';
        const STORE_HISTORY = 'history_logs';
        const STORE_CONFIG = 'department_configs';
        
        // Campus-Department Mapping
        const ACADEMIC_DEPTS = ['Kindergarten', 'Primary', 'Secondary', 'English', 'Academic Head - Kinder', 'Academic Head - Primary', 'Academic Head - HS', 'Vice Principal'];
        const GS_DEPTS = [
            'Accounts (ບັນຊີ)', 
            'Admin (ບໍລິຫານ)', 
            'Secretary (ເລຂານຸການ)', 
            'Invitational Teachers (ຄູຮັບເຊີນ)', 
            'Cooks (ແມ່ຄົວ)', 
            'Cleaners (ພະນັກງານອະນາໄມ)', 
            'Drivers (ພະນັກງານຂັບລົດ)', 
            'Repair (ສ້ອມແປງ)'
        ];
        const DEFAULT_DEPTS = [...ACADEMIC_DEPTS, ...GS_DEPTS];
        const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const CAMPUSES = ['Sibounheuang', 'Chommany', 'General Services'];
        
        const LAO_FIELDS = {
            research: 'ດຸໝັ່ນຄົ້ນຄວ້າ&ພັດທະນາການສອນການສອນ (ຮູ້ນໍາໃຊ້ເຕັກນິກເພື່ອເຮັດໃຫ້ ນຮ ມັກຮຽນ)',
            media: 'ນຳໃຊ້ສື່ການສອນ/ແຕ່ງບົດສອນ/ຕິດຕາມພັດທະນາການ ນຮ.ຫ້າວຫັນໃນການປະກອບສ່ວນໃນວຽກອື່ນໆຂອງໂຮງຮຽນ',
            behaviorBasic: 'ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ໃສ່ໃຈນຳ ນັກຮຽນ', 
            classResp: 'ຄວາມຮັບຜິດຊອບໃນຫ້ອງຮຽນ : ທຸກໆຢ່າງ',
            policy: 'ນະໂຍບາຍອື່ນໆ',
            basic: 'ເງີນເດືອນພື້ນຖານ', 
            cert: 'ໃບປະກາດ: ປຕີ (ສອງແສນຫ້າສິບ) ຊັ້ນສູງ (ສອງແສນ) ຊັ້ນກາງ (ໜຶ່ງແສນຫ້າສິບ)',
            homeroom: 'ຄູປະຈຳຫ້ອງ/ຄູປະຈຳຫ້ອງສະໝຸດ/ຄູປະຈຳເດີ່ນກິລາ',
            behaviorStart: 'ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ນຮ/ໃສ່ໃຈນຳນັກຮຽນ', 
            start: 'ເລີ້ມຕົ້ນ',
            accumulated: 'ເງີນສະສົມປີຜ່ານມາ',
            increase: 'ເພີ້ມປະຈຳປີ 2025-2026'
        };
        
        // This array defines the EXACT order for standard Lao departments.
        const laoEarningsStruct = [ 
            LAO_FIELDS.research, 
            LAO_FIELDS.media, 
            LAO_FIELDS.behaviorBasic, 
            LAO_FIELDS.classResp, 
            LAO_FIELDS.policy, 
            LAO_FIELDS.basic, 
            LAO_FIELDS.cert, 
            LAO_FIELDS.homeroom, 
            LAO_FIELDS.behaviorStart, 
            LAO_FIELDS.start, 
            LAO_FIELDS.accumulated, 
            LAO_FIELDS.increase 
        ];
        
        const defaultDeductions = ['ຫັກເງີນອາກອນ 5% (ຕາມເງີນເດືອນຕົວຈິງ)', 'ຫັກປະກັນສັງຄົມ 5.5%', 'ມາຊ້າ', 'Others ອື່ນໆ'];

        let db = null;
        let employees = [];
        let history = [];
        let departmentConfigs = {};
        let selectedEmployee = null;
        let selectedOTLStaff = null;
        let currentPayrollState = {};
        let currentFilter = { campus: 'All', department: 'All' };
        let editorMonth = "";
        let editorYear = new Date().getFullYear();
        let tempProfilePic = null;
        let editingLoanIndex = -1;
        let currentHistoryId = null;

        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if(!db.objectStoreNames.contains(STORE_EMPLOYEES)) db.createObjectStore(STORE_EMPLOYEES, { keyPath: 'id' });
                    if(!db.objectStoreNames.contains(STORE_HISTORY)) db.createObjectStore(STORE_HISTORY, { keyPath: 'dateId' });
                    if(!db.objectStoreNames.contains(STORE_CONFIG)) db.createObjectStore(STORE_CONFIG, { keyPath: 'name' });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function transact(storeName, mode, op) {
            if(!db) await openDB();
            const tx = db.transaction(storeName, mode);
            const store = tx.objectStore(storeName);
            const req = op(store);
            return new Promise((res, rej) => {
                req.onsuccess = () => res(req.result);
                req.onerror = () => rej(req.error);
            });
        }

        async function initApp() {
            try {
                await openDB();
                const configs = await transact(STORE_CONFIG, 'readonly', (s) => s.getAll());
                if (configs.length === 0) {
                    for (const d of DEFAULT_DEPTS) {
                        let earnings = [];
                        let deductions = [...defaultDeductions];
                        
                        // Default logic: Academic gets full structure, GS gets simplified if not specified
                        // But importantly, we define GS explicitly here
                        if (ACADEMIC_DEPTS.includes(d) && d !== 'English') {
                            earnings = [...laoEarningsStruct];
                        } else if (d === 'English') {
                            earnings = []; deductions = [];
                        } else {
                            // General Services Defaults (Simplified)
                            if (d.includes('Accounts')) { 
                                earnings = ['Basic Pay (USD)', 'Exchange Rate (LAK)', 'ເງີນເດືອນພື້ນຖານ', 'ສະສົມປີຜ່ານມາ', 'ເພີ້ມປະຈຳປີ 2025-2026', 'ບໍລິຫານຫ້ອງການ/ບັນຊີ', 'ດຸໝັ່ນມາການ (ບໍ່ຂາດການ)', 'ພົວພັນວຽກທາງນອກ-ພາຍໃນ', 'ບັນຊີ ການເງີນວຽກອື່ນໆຂອງໂຮງຮຽນ']; 
                            } else if (d.includes('Invitational Teachers')) { 
                                earnings = ['ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)', 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)', 'ເງີນເດືອນ']; 
                            } else {
                                // Generic GS (Cooks, Drivers, etc)
                                earnings = ['ເງີນເດືອນ (Salary)', 'ເງີນເພີ່ມ (Allowance)', 'OT'];
                            }
                        }
                        
                        const cfg = { name: d, earnings, deductions };
                        await transact(STORE_CONFIG, 'readwrite', (s) => s.put(cfg));
                        departmentConfigs[d] = cfg;
                    }
                } else { 
                    configs.forEach(c => departmentConfigs[c.name] = c);
                }

                employees = await transact(STORE_EMPLOYEES, 'readonly', (s) => s.getAll());
                history = await transact(STORE_HISTORY, 'readonly', (s) => s.getAll());

                const savedTheme = localStorage.getItem('neerada_theme') || 'default';
                if(document.body.classList.contains('view-app')) document.body.classList.add(`theme-${savedTheme}`);
                
                const savedLogo = localStorage.getItem('neerada_school_logo');
                if (savedLogo) {
                   window.updateLogoDOM(savedLogo);
                }

                setupYearSelectors(); setupMonthSelectors(); window.updateDashboardStats(); renderDeptSidebar(); renderEmployeeList();
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                if (window.lucide) lucide.createIcons();
                updateDateWidget();
            } catch(e) { console.error("Init fail:", e); }
        }

        window.updateLogoDOM = (src) => {
            // Helper to update all logo instances
            const landingLogo = document.getElementById('landing-custom-logo');
            const landingIcon = document.getElementById('landing-logo-container');
            if(landingLogo && landingIcon) {
                landingLogo.src = src;
                landingLogo.classList.remove('hidden');
                landingIcon.classList.add('hidden');
            }
            const headerLogo = document.getElementById('header-custom-logo');
            if(headerLogo) {
                headerLogo.src = src;
                headerLogo.classList.remove('hidden');
            }
            const prevLogo = document.getElementById('prev-school-logo');
            if (prevLogo) {
                prevLogo.src = src;
                prevLogo.classList.remove('hidden');
            }
            const favEl = document.getElementById('app-favicon');
            const appleEl = document.getElementById('app-apple-touch-icon');
            if (favEl) favEl.href = src;
            if (appleEl) appleEl.href = src;
        };

        function getOrderedDepartments() {
            const allDepts = Object.keys(departmentConfigs);
            return allDepts.sort((a, b) => {
                const indexA = DEFAULT_DEPTS.indexOf(a);
                const indexB = DEFAULT_DEPTS.indexOf(b);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b);
            });
        }

        function setupYearSelectors() {
            const yr = new Date().getFullYear();
            const endYear = Math.max(2030, yr + 1);
            let opts = "";
            for (let i = yr - 2; i <= endYear; i++) opts += `<option value="${i}">${i}</option>`;
            const ids = ['filter-year', 'editor-year', 'save-year', 'otl-year', 'bulk-year', 'bulk-import-year'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const defaultOpt = (id === 'filter-year') ? `<option value="All">All Years</option>` : '';
                    el.innerHTML = defaultOpt + opts;
                    if (id !== 'filter-year') el.value = yr;
                }
            });
            editorYear = yr;
        }

        function setupMonthSelectors() {
            const m = MONTHS[new Date().getMonth()];
            const opts = MONTHS.map(mn => `<option value="${mn}">${mn}</option>`).join('');
            const ids = ['filter-month', 'editor-month', 'save-month', 'otl-month', 'bulk-month', 'bulk-import-month'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const defaultOpt = (id === 'filter-month') ? `<option value="All">All Months</option>` : '';
                    el.innerHTML = defaultOpt + opts;
                    if (id !== 'filter-month') el.value = m;
                }
            });
            editorMonth = m;
        }

        function updateDateWidget() { const el = document.getElementById('date-display'); if(el) el.innerText = new Date().toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); }
        function formatMoney(n) { return '₭ ' + parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
        function formatUSD(n) { return '$' + parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2}); }
        function formatCurrencyInput(input) {
             let val = input.value.replace(/,/g, '').replace(/[^0-9.]/g, '');
             if (val) {
                 const parts = val.split('.');
                 parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                 input.value = parts.join('.');
             } else {
                 input.value = '';
             }
        }

        function generateEmployeeID(emp, month, year) {
            let campusCode = "GENSERV";
            if (emp.campus === "Sibounheuang") campusCode = "SBH";
            else if (emp.campus === "Chommany") campusCode = "CHM";
            const deptCode = (emp.department || "U").charAt(0).toUpperCase();
            const nameCode = (emp.name || "STAFF").split(' ')[0].toUpperCase();
            const monthCode = month.substring(0, 3).toUpperCase();
            const yearCode = year.toString().slice(-2);
            return `${campusCode}-${deptCode}-${nameCode}-${monthCode}-${yearCode}`;
        }

        function renderDeptSidebar() {
            const tree = document.getElementById('dept-tree'); if(!tree) return;
            const currentDepts = getOrderedDepartments();
            let html = `<div onclick="window.setFilter('All', 'All')" class="cursor-pointer px-3 py-2 rounded mb-2 text-sm flex justify-between items-center gap-2 ${currentFilter.campus === 'All' && currentFilter.department === 'All' ? 'bg-blue-100 text-blue-800 font-bold' : 'text-gray-600 hover:bg-gray-200'}"><div class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> All Staff</div><span class="text-xs bg-black/10 px-1.5 py-0.5 rounded-full font-mono">${employees.length}</span></div>`; 
            
            CAMPUSES.forEach(campus => { 
                html += `<div class="mt-4 mb-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider flex justify-between items-center cursor-pointer text-blue-800 bg-blue-100 hover:bg-blue-200 transition-colors shadow-sm" onclick="window.setFilter('${campus}', 'All')">${campus}<i data-lucide="chevron-down" class="w-3 h-3 text-blue-500"></i></div>`; 
                let targetDepts = (campus === 'General Services') ? GS_DEPTS : ACADEMIC_DEPTS;
                const deptsToShow = currentDepts.filter(d => targetDepts.includes(d));
                deptsToShow.forEach(dept => { 
                    const count = employees.filter(e => e.campus === campus && e.department === dept).length; 
                    const isActive = currentFilter.campus === campus && currentFilter.department === dept;
                    html += `<div onclick="window.setFilter('${campus}', '${dept}')" class="cursor-pointer px-3 py-1.5 rounded ml-2 text-sm transition-colors flex justify-between items-center ${isActive ? 'bg-white shadow-sm text-blue-700 font-medium border-l-2 border-blue-500' : 'text-gray-500 hover:bg-gray-200 border-l-2 border-transparent'}"><span>${dept}</span><span class="text-[10px] ${isActive ? 'bg-blue-50 text-blue-600' : 'bg-gray-100 text-gray-400'} px-1.5 py-0.5 rounded-full font-mono">${count}</span></div>`; 
                }); 
            }); 
            tree.innerHTML = html;
            const bl = document.getElementById('current-filter-label'); if(bl) bl.innerText = currentFilter.department !== 'All' ? `${currentFilter.department} (${currentFilter.campus})` : 'All Staff';
            const delBtn = document.getElementById('delete-dept-button');
            if (delBtn) { if (currentFilter.department !== 'All') { delBtn.disabled = false; delBtn.classList.remove('opacity-50'); } else { delBtn.disabled = true; delBtn.classList.add('opacity-50'); } }
            if (window.lucide) lucide.createIcons();
        }

        window.setFilter = (c, d) => { currentFilter = { campus: c, department: d }; renderDeptSidebar(); renderEmployeeList(); };
        window.clearFilter = () => window.setFilter('All', 'All');

        function renderEmployeeList() {
            const list = document.getElementById('employee-list'); if(!list) return;
            let filtered = employees;
            if (currentFilter.campus !== 'All') filtered = filtered.filter(e => e.campus === currentFilter.campus);
            if (currentFilter.department !== 'All') filtered = filtered.filter(e => e.department === currentFilter.department);
            
            list.innerHTML = filtered.map(emp => {
                const hasBankName = emp.bankAccountName && emp.bankAccountName.trim() !== '';
                return `
                <div onclick="window.selectEmployee('${emp.id}')" class="p-3 rounded-lg cursor-pointer transition-all border mb-2 ${selectedEmployee?.id === emp.id ? 'bg-blue-50 border-blue-200 shadow-sm' : 'bg-white border-transparent hover:bg-gray-50'}">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                ${emp.profilePic ? `<img src="${emp.profilePic}" class="w-8 h-8 rounded-full object-cover">` : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"><i data-lucide="user" class="w-4 h-4 text-gray-400"></i></div>`}
                                ${hasBankName ? `<div class="absolute -top-1 -right-1 bg-green-500 rounded-full border border-white flex items-center justify-center" style="width:14px; height:14px;" title="Bank Account Name Set"><i data-lucide="check" class="w-2.5 h-2.5 text-white"></i></div>` : ''}
                            </div>
                            <div><p class="font-bold text-gray-800 text-sm">${emp.name}</p><p class="text-xs text-blue-600 font-medium">${emp.department}</p><p class="text-[10px] text-gray-400 mt-1">Modified: ${emp.lastModified ? new Date(emp.lastModified).toLocaleString() : 'N/A'}</p></div>
                        </div>
                        <button onclick="event.stopPropagation(); window.deleteEmployee('${emp.id}')" class="text-gray-300 hover:text-red-500 p-1" title="Delete Staff"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                    </div>
                </div>
            `}).join('');
            if (window.lucide) lucide.createIcons();
        }

        window.selectEmployee = (id) => { selectedEmployee = employees.find(e => String(e.id) === String(id)); loadPeriodData(); document.getElementById('empty-state').classList.add('hidden'); document.getElementById('editor-area').classList.remove('hidden'); renderEmployeeList(); };

        // --- CENTRAL CALCULATION LOGIC ---
        function recalculatePayrollState(dept, state) {
            // 1. Accounts: USD * Rate = Basic LAK
            if (dept.includes('Accounts')) {
                const usd = parseFloat(state['Basic Pay (USD)'] || 0);
                const rate = parseFloat(state['Exchange Rate (LAK)'] || 0);
                if (usd > 0 && rate > 0) {
                    state['ເງີນເດືອນພື້ນຖານ'] = usd * rate;
                }
            }
            // 2. Invitational Teachers: Hours * Rate = Salary
            else if (dept.includes('Invitational Teachers')) {
                const hrs = parseFloat(state['ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)'] || 0);
                const rate = parseFloat(state['ອັດຕາຊົ່ວໂມງ (Rate per Hour)'] || 0);
                if (hrs > 0 && rate > 0) {
                    state['ເງີນເດືອນ'] = hrs * rate;
                }
            }
            // 3. Standard Lao Departments (Auto-sum components)
            else if (dept !== 'English') {
                // Sum components for Basic Pay
                const bSum = [
                    LAO_FIELDS.research, 
                    LAO_FIELDS.media, 
                    LAO_FIELDS.behaviorBasic, 
                    LAO_FIELDS.classResp, 
                    LAO_FIELDS.policy
                ].reduce((a,c) => a + (parseFloat(state[c])||0), 0);
                
                state[LAO_FIELDS.basic] = bSum;

                // Sum components for Start Pay (Basic + Cert + Homeroom + BehaviorStart)
                const startSum = bSum + 
                    (parseFloat(state[LAO_FIELDS.cert])||0) + 
                    (parseFloat(state[LAO_FIELDS.homeroom])||0) + 
                    (parseFloat(state[LAO_FIELDS.behaviorStart])||0);
                
                state[LAO_FIELDS.start] = startSum;
            }
            return state;
        }

        function loadPeriodData() {
            if (!selectedEmployee) return;
            const m = document.getElementById('editor-month').value; const y = document.getElementById('editor-year').value;
            editorMonth = m; editorYear = y; const key = `${y}-${m}`;
            
            // Load state or create initial
            currentPayrollState = (selectedEmployee.payrollHistory && selectedEmployee.payrollHistory[key]) ? JSON.parse(JSON.stringify(selectedEmployee.payrollHistory[key])) : createInitialState(selectedEmployee.department);
            
            // Force recalculation on load to ensure data consistency
            recalculatePayrollState(selectedEmployee.department, currentPayrollState);
            
            renderEditor();
        }

        function createInitialState(dept) {
            if (dept === 'English') return { basicPay: 0, accumulated: 0, increase: 0, earningsOthersUSD: 0, otHours: 0, otRate: 0, itLAK: 0, extraWorkOthersLAK: 0, stipendLAK: 0, profTax: 0, absences: 0, visa: 0, deductionsOthersUSD: 0, insuranceLAK: 0, deductionsOthersLAK: 0, cashOut: 0, exchangeRate: 0, notes: "" };
            const cfg = departmentConfigs[dept] || { earnings: [], deductions: [] }; const state = {};
            cfg.earnings.forEach(f => state[f] = 0); cfg.deductions.forEach(f => state[f] = 0); return state;
        }

        function renderEditor() {
            const container = document.getElementById('editor-content'); const dept = selectedEmployee.department;
            if (dept === 'English') { renderEnglishEditor(container); renderPreview(); return; }
            const cfg = departmentConfigs[dept] || { earnings: [], deductions: [] };
            const earns = cfg.earnings.map(f => {
                const isCalc = (f === LAO_FIELDS.basic || f === LAO_FIELDS.start || f === 'ເງີນເດືອນພື້ນຖານ' || f === 'ເງີນເດືອນ');
                const highlight = isCalc ? (f === LAO_FIELDS.basic || f === 'ເງີນເດືອນພື້ນຖານ' || f === 'ເງີນເດືອນ' ? 'field-highlight-1' : 'field-highlight-2') : '';
                return `<div class="${highlight}"><label class="block text-[10px] font-bold text-gray-500 mb-1 truncate" title="${f}">${f}</label><input type="number" ${isCalc ? 'readonly' : ''} data-field="${f}" oninput="window.updatePayrollField('${f}', this.value)" class="w-full text-sm border rounded p-1.5" value="${currentPayrollState[f] || 0}"></div>`;
            }).join('');
            const deds = cfg.deductions.map(f => `<div><label class="block text-[10px] font-bold text-gray-500 mb-1 truncate">${f}</label><input type="number" data-field="${f}" oninput="window.updatePayrollField('${f}', this.value)" class="w-full text-sm border rounded p-1.5 text-red-600" value="${currentPayrollState[f] || 0}"></div>`).join('');
            
            // Add Notes Field for General Depts
            const notesField = `<div class="mt-4"><label class="block text-xs font-bold text-gray-500 mb-1">Notes</label><textarea class="w-full border rounded p-2 text-xs" rows="2" oninput="window.updatePayrollField('notes', this.value)">${currentPayrollState.notes || ''}</textarea></div>`;
            
            container.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4"><h3 class="font-bold text-gray-700 border-b pb-2 mb-3 text-xs uppercase">Earnings (LAK)</h3><div class="grid grid-cols-2 gap-3">${earns}</div></div><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h3 class="font-bold text-red-700 border-b pb-2 mb-3 text-xs uppercase">Deductions (LAK)</h3><div class="grid grid-cols-2 gap-3">${deds}</div></div>${notesField}`;
            renderPreview();
        }

        function renderEnglishEditor(container) {
            const d = currentPayrollState;
            container.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 space-y-2 text-xs">
            <div class="flex justify-between items-center border-b pb-2">
                <h3 class="font-bold text-blue-700">Settings</h3>
                <div class="flex gap-2">
                    <div>
                        <label class="block text-[9px] font-bold mb-1 flex items-center gap-1">
                            Rate 
                            <button onclick="window.openRateCalculator()" class="text-blue-600 hover:bg-blue-100 p-0.5 rounded" title="Calculator & History"><i data-lucide="calculator" class="w-3 h-3"></i></button>
                        </label>
                        <input type="number" id="eng-exchange-rate" value="${d.exchangeRate}" oninput="window.updatePayrollField('exchangeRate', this.value)" onchange="window.propagateEnglishRate(this.value)" class="w-20 border rounded text-right p-1 bg-yellow-50 font-bold text-blue-800">
                    </div>
                    <div><label class="block text-[9px] font-bold mb-1">CashOut</label><input type="number" value="${d.cashOut}" oninput="window.updatePayrollField('cashOut', this.value)" class="w-12 border rounded text-right p-1"></div>
                </div>
            </div>
            <h3 class="font-bold text-gray-600 mt-2 mb-2">EARNINGS (USD)</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Basic Pay</label><input type="number" class="w-full border rounded p-1" value="${d.basicPay||0}" oninput="window.updatePayrollField('basicPay', this.value)"></div><div><label class="block font-bold mb-1">Accumulated</label><input type="number" class="w-full border rounded p-1" value="${d.accumulated||0}" oninput="window.updatePayrollField('accumulated', this.value)"></div><div><label class="block font-bold mb-1">Increase</label><input type="number" class="w-full border rounded p-1" value="${d.increase||0}" oninput="window.updatePayrollField('increase', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.earningsOthersUSD||0}" oninput="window.updatePayrollField('earningsOthersUSD', this.value)"></div></div><h3 class="font-bold text-gray-600 mt-4 mb-2">OVERTIME (USD)</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Total Hours</label><input type="number" class="w-full border rounded p-1" value="${d.otHours||0}" oninput="window.updatePayrollField('otHours', this.value)"></div><div><label class="block font-bold mb-1">Rate/Hr</label><input type="number" class="w-full border rounded p-1" value="${d.otRate||0}" oninput="window.updatePayrollField('otRate', this.value)"></div></div><h3 class="font-bold text-purple-700 mt-4 mb-2">EXTRA WORK (LAK)</h3><div class="grid grid-cols-3 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">IT</label><input type="number" class="w-full border rounded p-1" value="${d.itLAK||0}" oninput="window.updatePayrollField('itLAK', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.extraWorkOthersLAK||0}" oninput="window.updatePayrollField('extraWorkOthersLAK', this.value)"></div><div><label class="block font-bold mb-1">Stipend</label><input type="number" class="w-full border rounded p-1" value="${d.stipendLAK||0}" oninput="window.updatePayrollField('stipendLAK', this.value)"></div></div></div><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mt-4 space-y-2 text-xs"><h3 class="font-bold text-red-700 border-b pb-2 mb-2">DEDUCTIONS</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Prof. Tax</label><input type="number" class="w-full border rounded p-1" value="${d.profTax||0}" oninput="window.updatePayrollField('profTax', this.value)"></div><div><label class="block font-bold mb-1">Absences</label><input type="number" class="w-full border rounded p-1" value="${d.absences||0}" oninput="window.updatePayrollField('absences', this.value)"></div><div><label class="block font-bold mb-1">Visa</label><input type="number" class="w-full border rounded p-1" value="${d.visa||0}" oninput="window.updatePayrollField('visa', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.deductionsOthersUSD||0}" oninput="window.updatePayrollField('deductionsOthersUSD', this.value)"></div></div><h4 class="font-bold text-red-500 mt-4 mb-2 text-[10px]">LAK DEDUCTIONS</h4><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Insurance</label><input type="number" class="w-full border rounded p-1" value="${d.insuranceLAK||0}" oninput="window.updatePayrollField('insuranceLAK', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.deductionsOthersLAK||0}" oninput="window.updatePayrollField('deductionsOthersLAK', this.value)"></div></div></div><div class="mt-4"><label class="block text-xs font-bold text-gray-500 mb-1">Notes</label><textarea class="w-full border rounded p-2 text-xs" rows="2" oninput="window.updatePayrollField('notes', this.value)">${d.notes || ''}</textarea></div>`;
            if (window.lucide) lucide.createIcons();
        }

        window.updatePayrollField = async (f, v) => {
            if(f === 'notes') {
                currentPayrollState[f] = v;
            } else {
                currentPayrollState[f] = parseFloat(v) || 0;
            }
            
            // Recalculate all auto-fields based on new input
            recalculatePayrollState(selectedEmployee.department, currentPayrollState);
            
            // Update UI for calculated fields (read-only inputs) without re-rendering everything (preserves focus)
            const updateUIField = (fieldName) => {
                const input = document.querySelector(`input[data-field="${fieldName}"]`);
                if(input) input.value = currentPayrollState[fieldName] || 0;
            };

            if (selectedEmployee.department.includes('Accounts')) {
                updateUIField('ເງີນເດືອນພື້ນຖານ');
            }
            else if (selectedEmployee.department.includes('Invitational Teachers')) {
                updateUIField('ເງີນເດືອນ');
            }
            else if (selectedEmployee.department !== 'English') {
                updateUIField(LAO_FIELDS.basic);
                updateUIField(LAO_FIELDS.start);
            }
            
            renderPreview();
        };
        
        // --- NEW ENGLISH DEPT FEATURES ---
        window.openRateCalculator = () => {
            // Populate history table inside modal
            const list = document.getElementById('calc-history-list');
            const englishStaff = employees.filter(e => e.department === 'English');
            const historyMap = {}; // Key: "Year-Month", Value: Rate

            englishStaff.forEach(emp => {
                if(emp.payrollHistory) {
                    Object.keys(emp.payrollHistory).forEach(key => {
                        const rate = emp.payrollHistory[key].exchangeRate;
                        if(rate > 0) {
                            historyMap[key] = rate; 
                        }
                    });
                }
            });

            const sortedKeys = Object.keys(historyMap).sort((a, b) => b.localeCompare(a)); 
            if (sortedKeys.length === 0) {
                list.innerHTML = `<p class="text-gray-400 text-center py-2">No history recorded.</p>`;
            } else {
                list.innerHTML = sortedKeys.map(key => `<div class="flex justify-between border-b border-gray-200 last:border-0 py-1"><span>${key}</span><span class="font-mono font-bold text-blue-800">${formatMoney(historyMap[key])}</span></div>`).join('');
            }
            
            // Clear inputs
            document.getElementById('calc-buy').value = '';
            document.getElementById('calc-sell').value = '';
            document.getElementById('calc-result').innerText = '0';
            
            document.getElementById('rate-calc-modal').classList.remove('hidden');
            document.getElementById('rate-calc-modal').classList.add('flex');
        };

        window.calculateRateAvg = () => {
            const buy = parseFloat(document.getElementById('calc-buy').value) || 0;
            const sell = parseFloat(document.getElementById('calc-sell').value) || 0;
            const avg = (buy + sell) / 2;
            document.getElementById('calc-result').innerText = avg > 0 ? formatMoney(avg) : '0';
        };

        window.applyCalculatedRate = () => {
            const resultText = document.getElementById('calc-result').innerText.replace(/[^\d.]/g, '');
            const rate = parseFloat(resultText);
            
            if (rate > 0) {
                // Update input visually
                const input = document.getElementById('eng-exchange-rate');
                if(input) {
                    input.value = rate;
                    // Trigger local update
                    window.updatePayrollField('exchangeRate', rate);
                    // Trigger global propagation
                    window.propagateEnglishRate(rate);
                }
                document.getElementById('rate-calc-modal').classList.add('hidden');
                document.getElementById('rate-calc-modal').classList.remove('flex');
            } else {
                alert("Please calculate a valid rate first.");
            }
        };

        window.propagateEnglishRate = async (val) => {
            const rate = parseFloat(val) || 0;
            const key = `${editorYear}-${editorMonth}`;
            const englishStaff = employees.filter(e => e.department === 'English');
            let count = 0;
            
            for (const emp of englishStaff) {
                if (!emp.payrollHistory) emp.payrollHistory = {};
                // If history for this month doesn't exist, create it so we can set the rate
                if (!emp.payrollHistory[key]) emp.payrollHistory[key] = createInitialState('English');
                
                // Update rate
                emp.payrollHistory[key].exchangeRate = rate;
                
                // Save
                emp.lastModified = new Date().toISOString();
                await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
                count++;
            }
            
            // Refresh global employees array
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            
            // Reload current employee if they are English dept to ensure sync
            if(selectedEmployee && selectedEmployee.department === 'English') {
                selectedEmployee = employees.find(e => e.id === selectedEmployee.id);
            }
        };

        function calculatePayrollFromState(emp, state) {
            // FIX: Ensure calculations are fresh before summing
            // Create a copy to calculate without mutating the original history
            const d = JSON.parse(JSON.stringify(state));
            recalculatePayrollState(emp.department, d);

            if (emp.department === 'English') {
                const ot = (parseFloat(d.otHours)||0)*(parseFloat(d.otRate)||0);
                const gross = (parseFloat(d.basicPay)||0)+(parseFloat(d.accumulated)||0)+(parseFloat(d.increase)||0)+(parseFloat(d.earningsOthersUSD)||0) + ot;
                const dedUSD = (parseFloat(d.profTax)||0)+(parseFloat(d.absences)||0)+(parseFloat(d.visa)||0)+(parseFloat(d.deductionsOthersUSD)||0);
                const netUSD = gross - dedUSD;
                const convert = netUSD - (parseFloat(d.cashOut)||0);
                const convLAK = convert * (parseFloat(d.exchangeRate)||0);
                // FIXED: Changed itOthersLAK to extraWorkOthersLAK
                const extra = (parseFloat(d.itLAK)||0)+(parseFloat(d.extraWorkOthersLAK)||0)+(parseFloat(d.stipendLAK)||0);
                const dedLAK = (parseFloat(d.insuranceLAK)||0)+(parseFloat(d.deductionsOthersLAK)||0) + (parseFloat(d.loanDeduction)||0); 
                return { lak: Math.max(0, convLAK + extra - dedLAK), usd: parseFloat(d.cashOut)||0 };
            }
            const cfg = departmentConfigs[emp.department] || { earnings: [], deductions: [] }; let te = 0, td = 0;
            
            // Standard Lao Dept logic Update: Exclude Basic Pay, Include Start + After
            const isStandardLaoDept = !emp.department.includes('Accounts') && !emp.department.includes('Invitational Teachers') && !['English'].includes(emp.department) && !GS_DEPTS.includes(emp.department);
            
            cfg.earnings.forEach(f => {
                const v = parseFloat(d[f] || 0); // Use the calculated copy 'd'
                
                if (isStandardLaoDept) {
                     // Find index of current field and start field in the config
                     const earnList = cfg.earnings; 
                     const startIndex = earnList.indexOf(LAO_FIELDS.start);
                     const currIndex = earnList.indexOf(f);
                     
                     // Rule: Add Start (index 9) and everything after it. Ignore everything before.
                     // Also ignore 'Basic Pay (USD)' and 'Exchange Rate (LAK)' if they appear (defensive)
                     if (f !== 'Basic Pay (USD)' && f !== 'Exchange Rate (LAK)') {
                         if (startIndex !== -1) {
                             if (currIndex >= startIndex) {
                                 te += v;
                             }
                         } else {
                             // Fallback if 'Start' field missing from config
                             if (f !== LAO_FIELDS.basic) te += v; 
                         }
                     }
                } else {
                     // General Services & others: Sum everything except informational fields
                     if (!['Basic Pay (USD)', 'Exchange Rate (LAK)', 'ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)', 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)'].includes(f)) {
                        te += v;
                     }
                }
            });

            if (d.overtimeAmount) te += parseFloat(d.overtimeAmount);
            cfg.deductions.forEach(f => td += parseFloat(d[f] || 0));
            if (d.loanDeduction) td += parseFloat(d.loanDeduction);
            return { lak: Math.max(0, te - td), usd: 0 };
        }

        window.viewEmployeeHistory = () => { if (!selectedEmployee) return; document.getElementById('hist-emp-name').innerText = selectedEmployee.name; document.getElementById('hist-emp-dept').innerText = selectedEmployee.department; const rows = document.getElementById('hist-rows'); const historyData = selectedEmployee.payrollHistory || {}; const sortedKeys = Object.keys(historyData).sort((a,b) => b.localeCompare(a)); let totalHistoryLAK = 0; let totalHistoryUSD = 0; if (sortedKeys.length === 0) { rows.innerHTML = '<p class="text-center text-gray-400 py-8">No history recorded for this staff member.</p>'; } else { rows.innerHTML = sortedKeys.map(key => { const total = calculatePayrollFromState(selectedEmployee, historyData[key]); totalHistoryLAK += total.lak; totalHistoryUSD += total.usd; return `<div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border border-gray-100"><div><p class="font-bold text-blue-900">${key}</p><p class="text-xs text-gray-500">Recorded Period</p></div><div class="text-right"><div class="flex flex-col items-end gap-0.5"><span class="font-mono font-bold text-green-700 text-sm">${formatMoney(total.lak)}</span><span class="font-mono font-bold text-blue-600 text-xs">${formatUSD(total.usd)}</span></div><button onclick="window.applyHistoryEntry('${key}')" class="text-[10px] text-gray-400 underline hover:text-blue-600 mt-1">Load to Editor</button></div></div>`; }).join(''); } document.getElementById('hist-total-lak').innerText = formatMoney(totalHistoryLAK); document.getElementById('hist-total-usd').innerText = formatUSD(totalHistoryUSD); document.getElementById('employee-history-modal').classList.remove('hidden'); if (window.lucide) lucide.createIcons(); };
        window.applyHistoryEntry = (key) => { if (!selectedEmployee?.payrollHistory?.[key]) return; currentPayrollState = JSON.parse(JSON.stringify(selectedEmployee.payrollHistory[key])); renderEditor(); document.getElementById('employee-history-modal').classList.add('hidden'); };
        window.editCurrentStaff = () => { if(selectedEmployee) { window.openStaffModal(selectedEmployee.id); } else { alert("Please select an employee first."); } };
        window.loadPreviousMonthData = () => { if (!selectedEmployee) return; const currMIdx = MONTHS.indexOf(editorMonth); let prevMIdx = currMIdx - 1; let prevYr = parseInt(editorYear); if (prevMIdx < 0) { prevMIdx = 11; prevYr--; } const prevKey = `${prevYr}-${MONTHS[prevMIdx]}`; if (selectedEmployee.payrollHistory && selectedEmployee.payrollHistory[prevKey]) { if (confirm(`Copy data from ${MONTHS[prevMIdx]} ${prevYr}?`)) { currentPayrollState = JSON.parse(JSON.stringify(selectedEmployee.payrollHistory[prevKey])); renderEditor(); } } else { alert(`No data found for ${MONTHS[prevMIdx]} ${prevYr}`); } };
        window.resetCurrentPayroll = () => { if (!selectedEmployee) return; if (confirm("Reset current editor data to zero?")) { currentPayrollState = createInitialState(selectedEmployee.department); renderEditor(); } };
        window.sendWhatsApp = () => { if (!selectedEmployee) return; const phone = selectedEmployee.whatsapp || ""; const text = encodeURIComponent(constructPayslipMessage()); window.open(`https://wa.me/${phone.replace(/\D/g, '')}?text=${text}`, '_blank'); };
        window.sendEmail = () => { if (!selectedEmployee) return; const email = selectedEmployee.email || ""; const subject = encodeURIComponent(`Payslip - ${editorMonth} ${editorYear} - ${selectedEmployee.name}`); const body = encodeURIComponent(constructPayslipMessage().replace(/\*/g, '')); window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_self'); };
        window.saveEmployeePayrollData = async () => { const key = `${editorYear}-${editorMonth}`; if (!selectedEmployee.payrollHistory) selectedEmployee.payrollHistory = {}; selectedEmployee.payrollHistory[key] = JSON.parse(JSON.stringify(currentPayrollState)); selectedEmployee.lastModified = new Date().toISOString(); await transact(STORE_EMPLOYEES, 'readwrite', (s) => s.put(selectedEmployee)); window.updateDashboardStats(); renderEmployeeList(); alert("Saved!"); };
        window.handleLogoUpload = (input) => { const reader = new FileReader(); reader.onload = (e) => { const dataUrl = e.target.result; localStorage.setItem('neerada_school_logo', dataUrl); window.location.reload(); }; if (input.files[0]) reader.readAsDataURL(input.files[0]); };
        window.handleProfileUpload = (input) => { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { tempProfilePic = e.target.result; const prev = document.getElementById('form-preview-pic'); prev.src = tempProfilePic; prev.classList.remove('hidden'); document.getElementById('form-default-icon').classList.add('hidden'); document.getElementById('delete-modal-photo-btn').classList.remove('hidden'); }; reader.readAsDataURL(file); };
        window.clearModalPhoto = () => { tempProfilePic = null; document.getElementById('form-profile-pic').value = ""; const prev = document.getElementById('form-preview-pic'); prev.src = ""; prev.classList.add('hidden'); document.getElementById('form-default-icon').classList.remove('hidden'); document.getElementById('delete-modal-photo-btn').classList.add('hidden'); };
        window.deleteEmployee = async (id) => { if (!confirm("Are you sure you want to delete this staff member? This action cannot be undone.")) return; await transact(STORE_EMPLOYEES, 'readwrite', s => s.delete(id)); employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); if (selectedEmployee && selectedEmployee.id === id) { selectedEmployee = null; document.getElementById('editor-area').classList.add('hidden'); document.getElementById('empty-state').classList.remove('hidden'); } renderEmployeeList(); renderDeptSidebar(); window.updateDashboardStats(); };
        window.filterModalDepts = (preselectValue = null) => { const campus = document.getElementById('form-campus').value; const deptSelect = document.getElementById('form-department'); const currentVal = preselectValue || deptSelect.value; const allDepts = getOrderedDepartments(); const filteredOptions = allDepts.filter(d => { const isAcademic = ACADEMIC_DEPTS.includes(d); const isGS = GS_DEPTS.includes(d); if (campus === 'General Services') return isGS || (!isAcademic && !isGS); else return isAcademic || (!isAcademic && !isGS); }); deptSelect.innerHTML = filteredOptions.map(d => `<option value="${d}">${d}</option>`).join(''); if (filteredOptions.includes(currentVal)) { deptSelect.value = currentVal; } else if (filteredOptions.length > 0) { deptSelect.value = filteredOptions[0]; } window.toggleBankFields(); };
        window.openStaffModal = (id) => { 
            document.getElementById('add-form').reset(); document.getElementById('form-id').value = ""; window.clearModalPhoto(); 
            // Clear warning
            document.getElementById('bank-name-warning').classList.add('hidden');
            document.getElementById('form-bank-name').classList.remove('border-red-500');

            if(id) { const emp = employees.find(e => String(e.id) === String(id)); if (emp) { document.getElementById('modal-title').innerText = "Edit Staff Details"; document.getElementById('form-id').value = emp.id; document.getElementById('form-name').value = emp.name; document.getElementById('form-position').value = emp.position; document.getElementById('form-bank-name').value = emp.bankAccountName || ""; const targetCampus = emp.campus || (ACADEMIC_DEPTS.includes(emp.department) ? "Sibounheuang" : "General Services"); document.getElementById('form-campus').value = targetCampus; window.filterModalDepts(emp.department); document.getElementById('form-department').value = emp.department; document.getElementById('form-bank-lak').value = emp.bankLak || ""; document.getElementById('form-bank-usd').value = emp.bankUsd || ""; document.getElementById('form-email').value = emp.email || ""; document.getElementById('form-whatsapp').value = emp.whatsapp || ""; if(emp.profilePic) { tempProfilePic = emp.profilePic; const prev = document.getElementById('form-preview-pic'); prev.src = emp.profilePic; prev.classList.remove('hidden'); document.getElementById('form-default-icon').classList.add('hidden'); document.getElementById('delete-modal-photo-btn').classList.remove('hidden'); } } } else { document.getElementById('modal-title').innerText = "Add Staff"; document.getElementById('form-campus').value = "Sibounheuang"; window.filterModalDepts(); } document.getElementById('add-modal').classList.remove('hidden'); document.getElementById('add-modal').classList.add('flex'); window.toggleBankFields(); 
            
            // Trigger check initially
            window.checkBankName(document.getElementById('form-bank-name'));
            
            if (window.lucide) lucide.createIcons(); 
        };
        window.checkBankName = (input) => {
            const warning = document.getElementById('bank-name-warning');
            if (input.value.trim() === "") {
                warning.classList.remove('hidden');
                input.classList.add('border-red-500');
            } else {
                warning.classList.add('hidden');
                input.classList.remove('border-red-500');
            }
        };
        window.saveEmployee = async (e) => { e.preventDefault(); const fd = new FormData(e.target); const data = Object.fromEntries(fd.entries()); const ex = employees.find(x => x.id === data.id); data.id = data.id || 'EMP_' + Date.now(); data.payrollHistory = ex ? (ex.payrollHistory || {}) : {}; data.profilePic = tempProfilePic; data.lastModified = new Date().toISOString(); if (ex && ex.activeLoans) data.activeLoans = ex.activeLoans; if(ex && ex.archivedLoans) data.archivedLoans = ex.archivedLoans; await transact(STORE_EMPLOYEES, 'readwrite', (s) => s.put(data)); employees = await transact(STORE_EMPLOYEES, 'readonly', (s) => s.getAll()); renderEmployeeList(); renderDeptSidebar(); window.closeModal(); window.updateDashboardStats(); if(selectedEmployee?.id === data.id) { selectedEmployee = data; renderPreview(); } };
        window.closeModal = () => document.getElementById('add-modal').classList.add('hidden');
        window.loadDeptConfig = () => { 
            const select = document.getElementById('config-dept-select'); 
            const currentDepts = getOrderedDepartments(); 
            if (select && select.options.length === 0) select.innerHTML = currentDepts.map(d => `<option value="${d}">${d}</option>`).join(''); 
            const dept = select.value; 
            const cfg = departmentConfigs[dept]; 
            if(!cfg) return; 
            const ri = (type, list) => list.map((f, i) => `<div class="flex gap-2 mb-2 items-center"><input type="text" value="${f}" onchange="window.updateConfigFieldName('${dept}', '${type}', ${i}, this.value)" class="flex-1 p-2 border rounded text-sm"><button onclick="window.removeConfigField('${dept}', '${type}', ${i})" class="text-red-400 p-1 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join(''); 
            document.getElementById('config-editor-area').innerHTML = `<div class="p-6 bg-blue-50 rounded-xl border border-blue-100"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-blue-800 uppercase text-xs">Earnings</h4><button onclick="window.addConfigField('${dept}', 'earnings')" class="text-[10px] bg-blue-600 text-white px-2 py-1 rounded font-bold hover:bg-blue-700">+ Add</button></div><div id="cfg-earn-list">${ri('earnings', cfg.earnings)}</div></div><div class="p-6 bg-red-50 rounded-xl border border-red-100"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-red-800 uppercase text-xs">Deductions</h4><button onclick="window.addConfigField('${dept}', 'deductions')" class="text-[10px] bg-green-600 text-white px-2 py-1 rounded font-bold">+ Add</button></div><div id="cfg-ded-list">${ri('deductions', cfg.deductions)}</div></div>`; 
            
            // Populate bulk download dropdown excluding English
            const bulkSelect = document.getElementById('download-other-dept');
            if (bulkSelect) {
                const bulkOptions = currentDepts.filter(d => d !== 'English' && d !== 'Kindergarten' && d !== 'Primary' && d !== 'Secondary');
                bulkSelect.innerHTML = '<option value="">Download Other Dept...</option>' + bulkOptions.map(d => `<option value="${d}">${d}</option>`).join('');
            }
            
            if (window.lucide) lucide.createIcons(); 
        };
        window.updateConfigFieldName = (dept, type, idx, val) => { departmentConfigs[dept][type][idx] = val; }; window.addConfigField = (dept, type) => { departmentConfigs[dept][type].push("New Field"); window.loadDeptConfig(); }; window.removeConfigField = (dept, type, idx) => { departmentConfigs[dept][type].splice(idx, 1); window.loadDeptConfig(); }; window.saveDeptConfig = async () => { for (const d in departmentConfigs) await transact(STORE_CONFIG, 'readwrite', s => s.put(departmentConfigs[d])); alert("Saved!"); if (selectedEmployee) loadPeriodData(); renderDeptSidebar(); };
        window.addNewDept = async () => window.addDepartment();
        window.addDepartment = async () => { const name = prompt("Enter new Department name (e.g. Finance (ການເງິນ)):"); if (!name || name.trim() === "") return; if (departmentConfigs[name]) return alert("Department already exists."); const cfg = { name, earnings: [...laoEarningsStruct], deductions: [...defaultDeductions] }; await transact(STORE_CONFIG, 'readwrite', s => s.put(cfg)); departmentConfigs[name] = cfg; document.getElementById('config-dept-select').innerHTML = ""; window.loadDeptConfig(); renderDeptSidebar(); };
        window.renameDept = async () => { const select = document.getElementById('config-dept-select'); const oldName = select.value; if (!oldName) return; const newName = prompt("Enter new name for department:", oldName); if (!newName || newName.trim() === "" || newName === oldName) return; if (departmentConfigs[newName]) return alert("A department with this name already exists."); const cfg = JSON.parse(JSON.stringify(departmentConfigs[oldName])); cfg.name = newName; await transact(STORE_CONFIG, 'readwrite', s => { s.put(cfg); s.delete(oldName); }); for (const emp of employees.filter(e => e.department === oldName)) { emp.department = newName; await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp)); } employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); departmentConfigs[newName] = cfg; delete departmentConfigs[oldName]; select.innerHTML = ""; renderDeptSidebar(); renderEmployeeList(); window.loadDeptConfig(); document.getElementById('config-dept-select').value = newName; alert(`Renamed "${oldName}" to "${newName}".`); };
        window.deleteDept = async () => { const dept = document.getElementById('config-dept-select').value; if (employees.some(e => e.department === dept)) return alert("Cannot delete. Staff are assigned to this department."); if (!confirm(`Delete department "${dept}"?`)) return; await transact(STORE_CONFIG, 'readwrite', s => s.delete(dept)); delete departmentConfigs[dept]; document.getElementById('config-dept-select').innerHTML = ""; window.loadDeptConfig(); renderDeptSidebar(); };
        window.executePrint = () => { const o = document.querySelector('input[name="print-orient"]:checked').value; const s = parseFloat(document.getElementById('print-scale').value) / 100; let st = document.getElementById('print-dynamic-style'); if (!st) { st = document.createElement('style'); st.id = 'print-dynamic-style'; document.head.appendChild(st); } st.innerHTML = `@media print { @page { size: A4 ${o}; margin: 5mm; } #preview-pane { display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; transform: scale(${s}) !important; width: calc(100% / ${s}) !important; transform-origin: top left !important; } }`; window.closePrintSettings(); setTimeout(() => window.print(), 100); };
        window.updateDashboardStats = async () => { const vy = document.getElementById('filter-year'); const vm = document.getElementById('filter-month'); if(!vy || !vm) return; const yr = vy.value; const mn = vm.value; let liveTotalLAK = 0; let liveTotalUSD = 0; let liveStaffCount = 0; let breakdown = {}; employees.forEach(emp => { let empHasEntryInPeriod = false; if (emp.payrollHistory) { Object.keys(emp.payrollHistory).forEach(key => { const [kYr, kMn] = key.split('-'); const matchYr = (yr === 'All' || String(kYr) === String(yr)); const matchMn = (mn === 'All' || String(kMn) === String(mn)); if (matchYr && matchMn) { const result = calculatePayrollFromState(emp, emp.payrollHistory[key]); liveTotalLAK += result.lak; liveTotalUSD += result.usd; empHasEntryInPeriod = true; const c = emp.campus || "Unassigned"; const d = emp.department || "Unassigned"; if (!breakdown[c]) breakdown[c] = {}; if (!breakdown[c][d]) breakdown[c][d] = { lak: 0, usd: 0, staffIds: new Set() }; breakdown[c][d].lak += result.lak; breakdown[c][d].usd += result.usd; breakdown[c][d].staffIds.add(emp.id); } }); } if (empHasEntryInPeriod) liveStaffCount++; }); const lakEl = document.getElementById('stat-total-paid-lak'); if(lakEl) lakEl.innerText = formatMoney(liveTotalLAK); const usdEl = document.getElementById('stat-total-paid-usd'); if(usdEl) usdEl.innerText = formatUSD(liveTotalUSD); const empEl = document.getElementById('stat-employees'); if(empEl) empEl.innerText = liveStaffCount; const dbEl = document.getElementById('dept-breakdown'); if (dbEl) { let tableHtml = `<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-4 border-b border-gray-100 bg-gray-50"><h3 class="font-bold text-gray-700 text-xs uppercase">Department Breakdown</h3></div><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-500 text-xs uppercase font-medium"><tr><th class="px-4 py-3">Campus</th><th class="px-4 py-3">Department</th><th class="px-4 py-3 text-center">Active Staff</th><th class="px-4 py-3 text-right">Total Pay (LAK)</th><th class="px-4 py-3 text-right">Total Pay (USD)</th></tr></thead><tbody class="divide-y divide-gray-100">`; let hasRows = false; Object.keys(breakdown).sort().forEach(campus => { Object.keys(breakdown[campus]).sort().forEach(dept => { const data = breakdown[campus][dept]; hasRows = true; tableHtml += `<tr class="hover:bg-gray-50"><td class="px-4 py-3 font-medium text-blue-900">${campus}</td><td class="px-4 py-3">${dept}</td><td class="px-4 py-3 text-center">${data.staffIds.size}</td><td class="px-4 py-3 text-right font-mono text-blue-700">${formatMoney(data.lak)}</td><td class="px-4 py-3 text-right font-mono text-green-700">${formatUSD(data.usd)}</td></tr>`; }); }); if (!hasRows) { tableHtml += `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">No data available for this period.</td></tr>`; } tableHtml += `</tbody></table></div>`; dbEl.innerHTML = tableHtml; } const logs = await transact(STORE_HISTORY, 'readonly', s => s.getAll()); let fl = logs.filter(l => { const matchYear = (yr === 'All' || String(l.year) === String(yr)); const matchMonth = (mn === 'All' || String(l.month) === String(mn)); return matchYear && matchMonth; }); const latestLog = fl.sort((a,b) => b.dateId.localeCompare(a.dateId))[0]; const lastMonthEl = document.getElementById('stat-last-month'); const lastAmountEl = document.getElementById('stat-last-amount'); if (latestLog) { lastMonthEl.innerText = `${latestLog.month} ${latestLog.year}`; lastAmountEl.innerText = formatMoney(latestLog.totalLAK); } else { lastMonthEl.innerText = "No Finalized Runs"; lastAmountEl.innerText = "---"; } const hlist = document.getElementById('history-list'); if(hlist) { hlist.innerHTML = fl.sort((a,b) => b.dateId.localeCompare(a.dateId)).map(h => `<tr><td class="p-4 text-sm font-bold text-blue-900">${h.month} ${h.year}</td><td class="p-4 text-sm">${h.employeeCount} Staff</td><td class="p-4 text-sm text-right font-mono font-bold text-green-700">${formatMoney(h.totalLAK)}</td><td class="p-4 text-sm text-right font-mono font-bold text-green-700">$${(h.totalUSD || 0).toFixed(2)}</td><td class="p-4 text-right"><button onclick="window.deleteHistory('${h.dateId}')" class="text-red-500 text-xs underline font-bold">Delete Log</button></td></tr>`).join(''); } };
        window.deleteHistory = async (id) => { if (confirm("Delete this finalizing log? (This won't delete employee data)")) { await transact(STORE_HISTORY, 'readwrite', s => s.delete(id)); window.updateDashboardStats(); } };
        window.openSaveHistoryModal = () => document.getElementById('save-modal').classList.remove('hidden');
        window.savePayrollHistory = async (e) => { e.preventDefault(); const mn = document.getElementById('save-month').value; const yr = document.getElementById('save-year').value; const key = `${yr}-${mn}`; let totalLAK = 0; let totalUSD = 0; let count = 0; employees.forEach(emp => { if (emp.payrollHistory && emp.payrollHistory[key]) { const result = calculatePayrollFromState(emp, emp.payrollHistory[key]); totalLAK += result.lak; totalUSD += result.usd; count++; } }); await transact(STORE_HISTORY, 'readwrite', (s) => s.put({ dateId: key, month: mn, year: yr, totalLAK, totalUSD, employeeCount: count, timestamp: new Date().toISOString() })); window.updateDashboardStats(); document.getElementById('save-modal').classList.add('hidden'); };
        window.handleStaffCSV = (input) => { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { const text = e.target.result; const rows = text.split('\n').filter(r => r.trim()); if (rows.length < 2) return alert("Invalid CSV"); for (let i = 1; i < rows.length; i++) { const cols = rows[i].split(',').map(c => c.replace(/^"|"$/g, '').trim()); if (cols.length < 3) continue; const id = 'EMP_' + Date.now() + i; const name = cols[2]; const dept = cols[4]; const pos = cols[5]; await transact(STORE_EMPLOYEES, 'readwrite', s => s.put({ id, name, department: dept, position: pos, payrollHistory: {}, campus: "General Services" })); } employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); renderEmployeeList(); renderDeptSidebar(); }; reader.readAsText(file); };
        window.triggerImport = () => document.getElementById('staff-csv-input').click();
        window.deleteAllPhotos = async () => { if (!confirm("Remove all employee photos?")) return; for (const emp of employees) { emp.profilePic = null; await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp)); } employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); renderEmployeeList(); };
        window.setTheme = (theme) => { localStorage.setItem('neerada_theme', theme); document.body.className = `view-app theme-${theme}`; window.saveGlobalSettings({ theme: theme }); };
        window.downloadCSVReport = () => { 
            const yrFilter = document.getElementById('filter-year').value; 
            const mnFilter = document.getElementById('filter-month').value; 
            
            // Header for CSV
            let rows = [["PERIOD(mmm-YY)", "EMPLOYEE id", "NAME", "campus", "department", "phone/wa number", "position", "LAK ACCOUNT", "USD ACCOUNT", "TOTAL LAK", "TOTAL USD", "Loan PAYMENT"]]; 
            
            let grandTotalLAK = 0; 
            let grandTotalUSD = 0; 
            let normalRows = [];
            let cashRows = [];

            employees.forEach(emp => { 
                if(!emp.payrollHistory) return; 
                Object.keys(emp.payrollHistory).forEach(key => { 
                    const [y, m] = key.split('-'); 
                    if((yrFilter === 'All' || y === yrFilter) && (mnFilter === 'All' || m === mnFilter)) { 
                        const result = calculatePayrollFromState(emp, emp.payrollHistory[key]); 
                        const loanDed = parseFloat(emp.payrollHistory[key].loanDeduction || 0);
                        grandTotalLAK += result.lak; 
                        grandTotalUSD += result.usd; 
                        const csvEmpId = generateEmployeeID(emp, m, y); 
                        const periodStr = `${m.substring(0,3)}-${y.substring(2)}`;
                        const isCash = (emp.bankLak && (emp.bankLak.toLowerCase().includes('cash') || emp.bankLak.includes('ເງີນສົດ'))) || !emp.bankLak;
                        
                        const rowData = [
                            periodStr, 
                            csvEmpId, 
                            emp.name, 
                            emp.campus || "General Services", 
                            emp.department, 
                            (emp.whatsapp || emp.email || "N/A"),
                            emp.position, 
                            (emp.bankLak || "N/A"), 
                            (emp.bankUsd || "N/A"), 
                            result.lak, 
                            result.usd,
                            loanDed
                        ];

                        if(isCash) cashRows.push(rowData);
                        else normalRows.push(rowData);
                    } 
                }); 
            }); 
            
            // Combine Normal rows then Cash rows
            rows = [...rows, ...normalRows, ...cashRows];
            rows.push(["", "", "", "", "", "", "", "", "Grand Total", grandTotalLAK, grandTotalUSD, ""]); 
            
            const yrLabel = yrFilter === 'All' ? 'AllYears' : yrFilter; 
            const mnLabel = mnFilter === 'All' ? 'AllMonths' : mnFilter; 
            const filename = `Neerada_Payroll_Report_${yrLabel}_${mnLabel}_unified.csv`; 
            const csvContent = rows.map(r => r.map(cell => `"${cell}"`).join(",")).join("\n"); 
            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement("a"); 
            a.href = url; 
            a.download = filename; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
        };

        window.calculateBankSortIndex = (emp) => {
            const name = emp.name.toUpperCase();
            if (name.includes('NIRAPHONE KEOBOUNLOME')) return -10;
            if (name.includes('PHOUMANIPHONE KEOBOUNLOME')) return -9;
            if (name.includes('PHOUMANITHIP KEOBOUNLOME')) return -8;

            const isCash = (emp.bankLak && (emp.bankLak.toLowerCase().includes('cash') || emp.bankLak.includes('ເງີນສົດ'))) || !emp.bankLak;
            if(isCash) return 999;

            const c = emp.campus || "";
            const d = emp.department || "";

            // 1. Admin (General Services usually)
            if (d.includes('Admin') || d.includes('ບໍລິຫານ')) return 1;
            // 2. Secretary
            if (d.includes('Secretary') || d.includes('ເລຂານຸການ')) return 2;
            
            // 3. SBH Primary group
            if (c === 'Sibounheuang' && (d === 'Primary' || d === 'Academic Head - Primary')) return 3;
            
            // 4. SBH Secondary group (HS, VP)
            if (c === 'Sibounheuang' && (d === 'Secondary' || d === 'Academic Head - HS' || d === 'Vice Principal')) return 4;
            
            // 5. CHM Secondary group
            if (c === 'Chommany' && (d === 'Secondary' || d === 'Academic Head - HS' || d === 'Vice Principal')) return 5;
            
            // 6. SBH Kindergarten group
            if (c === 'Sibounheuang' && (d === 'Kindergarten' || d === 'Academic Head - Kinder')) return 6;
            
            // 7. CHM Kindergarten group
            if (c === 'Chommany' && (d === 'Kindergarten' || d === 'Academic Head - Kinder')) return 7;
            
            // 8. CHM Primary group
            if (c === 'Chommany' && (d === 'Primary' || d === 'Academic Head - Primary')) return 8;
            
            // 9. English
            if (d === 'English') return 9;
            
            // 10. Invitational
            if (d.includes('Invitational')) return 10;
            
            // 11. Others
            return 11;
        };

        window.downloadBankReport = () => {
            const yr = document.getElementById('filter-year').value;
            const mn = document.getElementById('filter-month').value;
            
            if (yr === 'All' || mn === 'All') return alert("Please select a specific Month and Year for the Bank Report.");

            const key = `${yr}-${mn}`;
            const periodStr = `${mn.substring(0,3).toUpperCase()}-${yr.substring(2)}`;
            
            // Collect data
            let data = [];
            
            employees.forEach(emp => {
                if (emp.payrollHistory && emp.payrollHistory[key]) {
                    const result = calculatePayrollFromState(emp, emp.payrollHistory[key]);
                    if (result.lak > 0) { // Only export if there is payment to be made
                        data.push({
                            emp: emp,
                            netPay: result.lak,
                            sortIndex: calculateBankSortIndex(emp)
                        });
                    }
                }
            });

            // Sort
            data.sort((a, b) => a.sortIndex - b.sortIndex);

            // Create CSV
            let rows = [["Account Number", "Net Pay (LAK)", "Bank Account Name", "Period (MM-YY)"]];
            data.forEach(item => {
                rows.push([
                    item.emp.bankLak || "",
                    item.netPay,
                    item.emp.bankAccountName || item.emp.name, // Fallback to name if account name empty
                    periodStr
                ]);
            });

            const csvContent = rows.map(r => r.map(cell => `"${cell}"`).join(",")).join("\n");
            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Neerada_Bank_Transfer_${mn}_${yr}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.exportDepartmentPayslipData = () => { const dept = currentFilter.department; if (dept === 'All') { alert("Please select a specific Department from the sidebar first to export its specific Payslip Data format."); return; } const yr = document.getElementById('editor-year').value; const mn = document.getElementById('editor-month').value; const key = `${yr}-${mn}`; const cfg = departmentConfigs[dept]; if (!cfg) return alert("Configuration not found for this department."); let headers = ["NAME", ...cfg.earnings, ...cfg.deductions, "NET PAY (LAK)"]; let rows = [headers]; const deptEmployees = employees.filter(e => e.department === dept); deptEmployees.forEach(emp => { const payData = (emp.payrollHistory && emp.payrollHistory[key]) ? emp.payrollHistory[key] : {}; let row = [emp.name]; let totalEarnings = 0; let totalDeductions = 0; cfg.earnings.forEach(f => { let val = payData[f] || 0; if (!dept.includes('Accounts') && !dept.includes('Invitational Teachers')) { if (f === LAO_FIELDS.basic) { val = [LAO_FIELDS.research, LAO_FIELDS.media, LAO_FIELDS.behaviorBasic, LAO_FIELDS.classResp, LAO_FIELDS.policy].reduce((a,c) => a + (parseFloat(payData[c])||0), 0); } if (f === LAO_FIELDS.start) { const basic = [LAO_FIELDS.research, LAO_FIELDS.media, LAO_FIELDS.behaviorBasic, LAO_FIELDS.classResp, LAO_FIELDS.policy].reduce((a,c) => a + (parseFloat(payData[c])||0), 0); val = basic + (parseFloat(payData[LAO_FIELDS.cert])||0) + (parseFloat(payData[LAO_FIELDS.homeroom])||0) + (parseFloat(payData[LAO_FIELDS.behaviorStart])||0); } } row.push(val); const isBasicResult = (f === LAO_FIELDS.basic || f === 'ເງີນເດືອນພື້ນຖານ' || f === 'ເງີນເດືອນ'); const isRate = (f === 'Exchange Rate (LAK)' || f === 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)' || f === 'ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)'); if (!isRate && f !== LAO_FIELDS.start && f !== 'Basic Pay (USD)') { if (isBasicResult) { if (dept.includes('Accounts') || dept.includes('Invitational Teachers') || f === LAO_FIELDS.basic) { totalEarnings += parseFloat(val); } } else { totalEarnings += parseFloat(val); } } }); if (payData.overtimeAmount) totalEarnings += parseFloat(payData.overtimeAmount); cfg.deductions.forEach(f => { const val = payData[f] || 0; row.push(val); totalDeductions += parseFloat(val); }); if (payData.loanDeduction) totalDeductions += parseFloat(payData.loanDeduction); const netPay = Math.max(0, totalEarnings - totalDeductions); row.push(netPay); rows.push(row); }); const csvContent = rows.map(r => r.map(cell => `"${cell}"`).join(",")).join("\n"); const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `PayslipData_${dept}_${mn}_${yr}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
        window.switchView = (v) => { 
            // Save current view
            localStorage.setItem('neerada_active_tab', v);
            
            ['dashboard', 'payroll', 'config', 'ot-loans'].forEach(i => { const el = document.getElementById('view-'+i); const tab = document.getElementById('tab-'+i); if(el) el.classList.add('hidden'); if(tab) tab.className = "px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors"; }); 
            const av = document.getElementById('view-'+v); const at = document.getElementById('tab-'+v); if(av) av.classList.remove('hidden'); if(at) at.className = "px-4 py-1.5 text-sm font-medium rounded-md bg-blue-800 text-white transition-colors"; if (v === 'config') window.loadDeptConfig(); if (v === 'dashboard') window.updateDashboardStats(); if (v === 'ot-loans') window.refreshOTLoansView(); 
        };
        window.refreshOTLoansView = () => { const list = document.getElementById('otl-staff-list'); list.innerHTML = employees.map(emp => `<div onclick="window.selectOTLStaff('${emp.id}')" class="p-2 cursor-pointer hover:bg-blue-50 border-b border-gray-100 text-xs flex justify-between items-center ${selectedOTLStaff?.id === emp.id ? 'bg-blue-100' : ''}"><span class="font-bold text-gray-700">${emp.name}</span><span class="text-gray-400 text-[10px]">${emp.department}</span></div>`).join(''); window.renderOTLOverview(); if (selectedOTLStaff) window.selectOTLStaff(selectedOTLStaff.id); };
        window.renderOTLOverview = () => { 
            const m = document.getElementById('otl-month').value; 
            const y = document.getElementById('otl-year').value; 
            const key = `${y}-${m}`; 
            document.getElementById('otl-report-period').innerText = `${m} ${y}`; 
            const loanTable = document.getElementById('otl-report-loans'); 
            let loanRows = ''; 
            let hasLoans = false; 
            let activeLoanCount = 0; 
            
            // Sort employees alphabetically by Name (trim spaces) - English A-Z
            const sortedEmployees = [...employees].sort((a, b) => a.name.trim().localeCompare(b.name.trim()));

            sortedEmployees.forEach(emp => { 
                if (emp.activeLoans && emp.activeLoans.length > 0) { 
                    let staffHasActive = false; 
                    let totalLoan = 0; 
                    let totalPaid = 0; 
                    let paymentThisMonth = (emp.payrollHistory && emp.payrollHistory[key]) ? (emp.payrollHistory[key].loanDeduction || 0) : 0; 
                    let payCount = 0; 
                    const descriptions = emp.activeLoans.map(l => { 
                        const bal = parseFloat(l.total) - parseFloat(l.paid || 0); 
                        if(bal > 0) { 
                            staffHasActive = true; 
                            totalLoan += parseFloat(l.total); 
                            totalPaid += parseFloat(l.paid || 0); 
                            payCount += (l.paymentCount || 0); 
                            return l.description; 
                        } 
                        return null; 
                    }).filter(Boolean).join(', '); 
                    
                    const dates = emp.activeLoans.map(l => (parseFloat(l.total)-parseFloat(l.paid||0))>0 ? (l.dateAdded || '-') : null).filter(Boolean).join(', '); 
                    const starts = emp.activeLoans.map(l => (parseFloat(l.total)-parseFloat(l.paid||0))>0 ? (l.startDate || '-') : null).filter(Boolean).join(', '); 
                    let balance = totalLoan - totalPaid; 
                    
                    if(staffHasActive) { 
                        hasLoans = true; 
                        activeLoanCount++; 
                        loanRows += `<tr class="hover:bg-gray-50 border-b border-gray-50"><td class="px-4 py-3 font-medium text-gray-800"><button onclick="window.showOTLHistory('${emp.id}')" class="hover:text-blue-600 hover:underline flex items-center gap-1">${emp.name} <i data-lucide="external-link" class="w-3 h-3 text-gray-400"></i></button></td><td class="px-4 py-3 text-gray-600 text-xs">${descriptions}</td><td class="px-4 py-3 text-center text-xs text-gray-500">${dates}</td><td class="px-4 py-3 text-center text-xs text-gray-500">${starts}</td><td class="px-4 py-3 text-right font-mono">${formatMoney(totalLoan)}</td><td class="px-4 py-3 text-right font-mono text-green-600">${formatMoney(totalPaid)}</td><td class="px-4 py-3 text-center font-bold text-gray-700">${payCount}</td><td class="px-4 py-3 text-right font-mono text-blue-600">${formatMoney(paymentThisMonth)}</td><td class="px-4 py-3 text-right font-mono font-bold text-red-600">${formatMoney(balance)}</td></tr>`; 
                    } 
                } 
            }); 
            loanTable.innerHTML = hasLoans ? loanRows : `<tr><td colspan="9" class="p-4 text-center text-gray-400">No active loans found.</td></tr>`; 
            document.getElementById('active-loans-header').innerHTML = `<i data-lucide="credit-card" class="w-4 h-4"></i> Active Loan Records (${activeLoanCount} Staff)`; 
            
            const otTable = document.getElementById('otl-report-ot'); 
            let otRows = ''; 
            let hasOT = false; 
            sortedEmployees.forEach(emp => { 
                if (emp.payrollHistory && emp.payrollHistory[key]) { 
                    const pd = emp.payrollHistory[key]; 
                    const isEnglish = emp.department === 'English'; 
                    let otAmt = isEnglish ? ((parseFloat(pd.otHours)||0) * (parseFloat(pd.otRate)||0)) : (parseFloat(pd.overtimeAmount)||0); 
                    if (otAmt > 0) { 
                        hasOT = true; 
                        otRows += `<tr class="hover:bg-gray-50 border-b border-gray-50"><td class="px-4 py-3 font-medium text-gray-800"><button onclick="window.showOTLHistory('${emp.id}')" class="hover:text-blue-600 hover:underline flex items-center gap-1">${emp.name} <i data-lucide="external-link" class="w-3 h-3 text-gray-400"></i></button></td><td class="px-4 py-3 text-gray-500 text-xs">${emp.department}</td><td class="px-4 py-3 text-right font-mono">${isEnglish ? pd.otHours + ' hrs' : '-'}</td><td class="px-4 py-3 text-right font-mono">${isEnglish ? '$'+pd.otRate : '-'}</td><td class="px-4 py-3 text-right font-mono font-bold text-blue-700">${isEnglish ? formatUSD(otAmt) : formatMoney(otAmt)}</td></tr>`; 
                    } 
                } 
            }); 
            otTable.innerHTML = hasOT ? otRows : `<tr><td colspan="5" class="p-4 text-center text-gray-400">No overtime records for ${m} ${y}.</td></tr>`; 
            if (window.lucide) lucide.createIcons(); 
        };
        
        window.showOTLHistory = (id) => { 
            const emp = employees.find(e => e.id === id); 
            if (!emp) return; 
            currentHistoryId = id; 
            document.getElementById('otl-hist-name').innerText = emp.name; 
            
            const activeBody = document.getElementById('otl-hist-active-loans'); 
            if (emp.activeLoans && emp.activeLoans.length > 0) { 
                // Header must match 6 columns: Desc, Date, Total, Paid, Balance, Action
                activeBody.innerHTML = emp.activeLoans.map((l, idx) => `<tr>
                    <td class="px-3 py-2 text-gray-800 font-medium text-xs">${l.description}</td>
                    <td class="px-3 py-2 text-center text-xs text-gray-500">${l.dateAdded || '-'}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs">${formatMoney(l.total)}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs text-green-600">${formatMoney(l.paid || 0)}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs font-bold text-red-600">${formatMoney(l.total - (l.paid || 0))}</td>
                    <td class="px-3 py-2 text-center flex justify-center gap-1">
                         <button onclick="window.deleteLoanFromHistory(${idx}, 'active')" class="text-red-400 hover:text-red-600 p-1" title="Delete Loan"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </td>
                </tr>`).join(''); 
            } else { 
                activeBody.innerHTML = `<tr><td colspan="6" class="p-3 text-center text-gray-400 text-xs">No active loans.</td></tr>`; 
            } 

            const archivedBody = document.getElementById('otl-hist-archived-loans');
            if (emp.archivedLoans && emp.archivedLoans.length > 0) {
                 // Header must match 4 columns: Desc, Date, Total, Action
                 archivedBody.innerHTML = emp.archivedLoans.map((l, idx) => `<tr>
                    <td class="px-3 py-2 font-medium text-xs">${l.description}</td>
                    <td class="px-3 py-2 text-center text-xs text-gray-500">${l.dateAdded || '-'}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs">${formatMoney(l.total)}</td>
                    <td class="px-3 py-2 text-center flex justify-center gap-1">
                        <button onclick="window.restoreArchivedLoan(${idx})" class="text-green-500 hover:text-green-700 p-1" title="Restore to Active"><i data-lucide="rotate-ccw" class="w-3 h-3"></i></button>
                        <button onclick="window.deleteLoanFromHistory(${idx}, 'archived')" class="text-red-400 hover:text-red-600 p-1" title="Delete Permanently"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </td>
                 </tr>`).join('');
            } else {
                 archivedBody.innerHTML = `<tr><td colspan="4" class="p-3 text-center text-gray-400 text-xs">No archived loans.</td></tr>`;
            }

            const histData = emp.payrollHistory || {}; 
            const periods = Object.keys(histData).sort((a,b) => b.localeCompare(a)); 
            const loanHistBody = document.getElementById('otl-hist-payments'); 
            let loanHistRows = ''; 
            let hasLoanHist = false; 
            
            const otHistBody = document.getElementById('otl-hist-ot'); 
            let otHistRows = ''; 
            let hasOtHist = false; 
            
            periods.forEach(key => { 
                const data = histData[key]; 
                const paid = parseFloat(data.loanDeduction || 0); 
                if (paid > 0) { 
                    hasLoanHist = true; 
                    loanHistRows += `<tr class="border-b border-gray-50 last:border-0">
                        <td class="px-3 py-2 font-medium text-gray-700 text-xs">${key}</td>
                        <td class="px-3 py-2 text-right font-mono font-bold text-green-700 text-xs">${formatMoney(paid)}</td>
                        <td class="px-3 py-2 text-center flex justify-center gap-1">
                            <button onclick="window.editHistoryPayment('${key}', ${paid})" class="text-blue-500 hover:text-blue-700 p-1" title="Edit Payment"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="window.deleteHistoryPayment('${key}', ${paid})" class="text-red-400 hover:text-red-600 p-1" title="Delete Payment"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </td>
                    </tr>`; 
                } 
                
                const isEnglish = emp.department === 'English'; 
                let otVal = 0; 
                let details = ''; 
                if (isEnglish) { 
                    const hrs = parseFloat(data.otHours || 0); 
                    const rate = parseFloat(data.otRate || 0); 
                    if (hrs > 0) { otVal = hrs * rate; details = `${hrs} hrs @ $${rate}`; } 
                } else { 
                    otVal = parseFloat(data.overtimeAmount || 0); 
                    details = 'Flat Amount'; 
                } 
                if (otVal > 0) { 
                    hasOtHist = true; 
                    otHistRows += `<tr class="border-b border-gray-50 last:border-0"><td class="px-3 py-2 font-medium text-gray-700 text-xs">${key}</td><td class="px-3 py-2 text-right text-xs text-gray-500">${details}</td><td class="px-3 py-2 text-right font-mono font-bold text-blue-700 text-xs">${isEnglish ? formatUSD(otVal) : formatMoney(otVal)}</td></tr>`; 
                } 
            }); 
            loanHistBody.innerHTML = hasLoanHist ? loanHistRows : `<tr><td colspan="3" class="p-3 text-center text-gray-400 text-xs">No payment records found.</td></tr>`; 
            otHistBody.innerHTML = hasOtHist ? otHistRows : `<tr><td colspan="3" class="p-3 text-center text-gray-400 text-xs">No overtime records found.</td></tr>`; 
            
            document.getElementById('otl-history-modal').classList.remove('hidden'); 
            if (window.lucide) lucide.createIcons(); 
        };

        window.deleteLoanFromHistory = async (idx, type) => {
            const emp = employees.find(e => e.id === currentHistoryId);
            if (!emp) return;
            
            if (!confirm(`Are you sure you want to delete this ${type} loan permanently?`)) return;
            
            if (type === 'active') {
                emp.activeLoans.splice(idx, 1);
            } else {
                emp.archivedLoans.splice(idx, 1);
            }
            
            emp.lastModified = new Date().toISOString();
            await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            
            window.showOTLHistory(currentHistoryId); // Refresh modal
            // Also refresh main views if they are open
            if(selectedOTLStaff && selectedOTLStaff.id === currentHistoryId) {
                selectedOTLStaff = emp; // update Ref
                renderLoanTable();
                window.renderOTLOverview();
            }
        };

        window.restoreArchivedLoan = async (idx) => {
            const emp = employees.find(e => e.id === currentHistoryId);
            if (!emp) return;
            if(!confirm("Restore this loan to Active status?")) return;
            
            const loan = emp.archivedLoans[idx];
            if(!emp.activeLoans) emp.activeLoans = [];
            emp.activeLoans.push(loan);
            emp.archivedLoans.splice(idx, 1);
            
            emp.lastModified = new Date().toISOString();
            await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            window.showOTLHistory(currentHistoryId);
        };

        window.editHistoryPayment = async (key, oldVal) => {
            const emp = employees.find(e => e.id === currentHistoryId);
            if (!emp || !emp.payrollHistory[key]) return;
            
            const newValStr = prompt(`Edit Loan Payment for ${key}.\nCurrent Amount: ${oldVal}\nEnter new amount (LAK):`, oldVal);
            if(newValStr === null) return; // Cancelled
            
            const newVal = parseFloat(newValStr.replace(/,/g, '')) || 0;
            if(isNaN(newVal)) return alert("Invalid amount.");
            
            const diff = newVal - oldVal;
            emp.payrollHistory[key].loanDeduction = newVal;
            
            // Optional Balance Adjustment
            if(diff !== 0 && emp.activeLoans && emp.activeLoans.length > 0) {
                if(confirm(`Payment changed by ${formatMoney(diff)}.\n\nShould I update the CURRENT active loan balance by this amount?\n(Click OK to adjust balance, Cancel to only change history record)`)) {
                    // Update the first active loan (simplest logic for single loan tracking)
                    emp.activeLoans[0].paid = (emp.activeLoans[0].paid || 0) + diff;
                    
                    // Adjust count if changing between 0 and non-zero
                    if (oldVal === 0 && newVal > 0) {
                        emp.activeLoans[0].paymentCount = (emp.activeLoans[0].paymentCount || 0) + 1;
                    } else if (oldVal > 0 && newVal === 0) {
                        emp.activeLoans[0].paymentCount = Math.max(0, (emp.activeLoans[0].paymentCount || 0) - 1);
                    }
                }
            }
            
            emp.lastModified = new Date().toISOString();
            await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            window.showOTLHistory(currentHistoryId);
            
            // Refresh main view if necessary
            if(selectedOTLStaff && selectedOTLStaff.id === currentHistoryId) {
                selectedOTLStaff = emp;
                renderLoanTable();
                window.renderOTLOverview();
            }
        };

        window.deleteHistoryPayment = async (key, oldVal) => {
            const emp = employees.find(e => e.id === currentHistoryId);
            if (!emp || !emp.payrollHistory[key]) return;
            
            if(!confirm(`Delete payment record for ${key} of amount ${formatMoney(oldVal)}?`)) return;
            
            emp.payrollHistory[key].loanDeduction = 0;
            
            // Optional Balance Adjustment
            if(emp.activeLoans && emp.activeLoans.length > 0) {
                 if(confirm(`You deleted a payment of ${formatMoney(oldVal)}.\n\nShould I REVERSE this from the active loan balance (increase debt) and decrement payment count?\n(Click OK to adjust loan, Cancel to leave loan as is)`)) {
                    // Reversing a payment means reducing the 'paid' amount
                    emp.activeLoans[0].paid = Math.max(0, (emp.activeLoans[0].paid || 0) - oldVal);
                    // Decrement payment count as requested
                    emp.activeLoans[0].paymentCount = Math.max(0, (emp.activeLoans[0].paymentCount || 0) - 1);
                }
            }

            emp.lastModified = new Date().toISOString();
            await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            window.showOTLHistory(currentHistoryId);
            
            // Refresh main view if necessary
            if(selectedOTLStaff && selectedOTLStaff.id === currentHistoryId) {
                selectedOTLStaff = emp;
                renderLoanTable();
                window.renderOTLOverview();
            }
        };

        window.goToManageFromHistory = () => { if(currentHistoryId) { window.selectOTLStaff(currentHistoryId); document.getElementById('otl-history-modal').classList.add('hidden'); } };
        window.filterOTLStaff = () => { const q = document.getElementById('otl-search').value.toLowerCase(); const list = document.getElementById('otl-staff-list'); list.innerHTML = employees.filter(e => e.name.toLowerCase().includes(q)).map(emp => `<div onclick="window.selectOTLStaff('${emp.id}')" class="p-2 cursor-pointer hover:bg-blue-50 border-b border-gray-100 text-xs flex justify-between items-center ${selectedOTLStaff?.id === emp.id ? 'bg-blue-100' : ''}"><span class="font-bold text-gray-700">${emp.name}</span><span class="text-gray-400 text-[10px]">${emp.department}</span></div>`).join(''); };
        window.selectOTLStaff = (id) => { 
            // Reset editing state whenever selecting a new staff to avoid cross-contamination
            editingLoanIndex = -1;
            document.getElementById('btn-cancel-loan').classList.add('hidden');
            document.getElementById('loan-form-title').innerText = "Add New Loan";
            document.getElementById('btn-save-loan').innerText = "Add Loan";
            document.getElementById('new-loan-desc').value = ""; 
            document.getElementById('new-loan-amount').value = ""; 
            document.getElementById('new-loan-date').value = ""; 
            document.getElementById('new-loan-start').value = "";

            selectedOTLStaff = employees.find(e => e.id === id); 
            document.getElementById('otl-overview').classList.add('hidden'); 
            document.getElementById('otl-empty-state').classList.add('hidden'); 
            document.getElementById('ot-management-card').classList.remove('hidden'); 
            document.getElementById('loan-management-card').classList.remove('hidden'); 
            document.getElementById('otl-selected-name').innerText = selectedOTLStaff.name; 
            
            if (!selectedOTLStaff.activeLoans) selectedOTLStaff.activeLoans = []; 
            
            // Auto-float history if user has loans
            if (selectedOTLStaff.activeLoans.length > 0) {
                window.showOTLHistory(id);
            }

            const m = document.getElementById('otl-month').value; 
            const y = document.getElementById('otl-year').value; 
            const key = `${y}-${m}`; 
            
            // Ensure payroll history exists
            if (!selectedOTLStaff.payrollHistory) selectedOTLStaff.payrollHistory = {}; 
            if (!selectedOTLStaff.payrollHistory[key]) selectedOTLStaff.payrollHistory[key] = createInitialState(selectedOTLStaff.department);
            
            const payData = selectedOTLStaff.payrollHistory[key]; 
            const otContainer = document.getElementById('ot-inputs-container'); 
            if (selectedOTLStaff.department === 'English') { 
                otContainer.innerHTML = `<div><label class="block text-xs font-bold text-gray-500 mb-1">OT Hours</label><input type="number" id="otl-hours" class="w-full border rounded p-2 text-sm" value="${payData.otHours || 0}"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">OT Rate ($)</label><input type="number" id="otl-rate" class="w-full border rounded p-2 text-sm" value="${payData.otRate || 0}"></div>`; 
            } else { 
                otContainer.innerHTML = `<div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">Total Overtime Amount (LAK)</label><input type="number" id="otl-amount" class="w-full border rounded p-2 text-sm font-bold text-blue-700 bg-blue-50" value="${payData.overtimeAmount || 0}"></div>`; 
            } 
            renderLoanTable(); 
            document.getElementById('otl-repay-month').innerText = `${m} ${y}`; 
            
            // Handle comma format for display
            let currentDed = payData.loanDeduction || 0;
            let currentDedStr = currentDed.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('loan-repay-amount').value = currentDed > 0 ? currentDedStr : "";
        };
        window.closeOTLEditor = () => { selectedOTLStaff = null; document.getElementById('otl-overview').classList.remove('hidden'); document.getElementById('ot-management-card').classList.add('hidden'); document.getElementById('loan-management-card').classList.add('hidden'); document.getElementById('otl-empty-state').classList.add('hidden'); window.refreshOTLoansView(); };
        function renderLoanTable() { 
            const list = document.getElementById('otl-loans-list'); 
            if (selectedOTLStaff.activeLoans.length === 0) { 
                list.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-400 text-xs">No active loans</td></tr>`; 
                return; 
            } 
            list.innerHTML = selectedOTLStaff.activeLoans.map((l, idx) => {
                const bal = parseFloat(l.total) - parseFloat(l.paid || 0);
                const isPaidOff = bal <= 0;
                return `<tr class="hover:bg-gray-50 ${isPaidOff ? 'bg-green-50 opacity-75' : ''}"><td class="px-3 py-2 font-medium">${l.description}</td><td class="px-3 py-2 text-center text-xs text-gray-500">${l.dateAdded || '-'}</td><td class="px-3 py-2 text-center text-xs text-gray-500">${l.startDate || '-'}</td><td class="px-3 py-2 text-right font-mono">${formatMoney(l.total)}</td><td class="px-3 py-2 text-right font-mono text-green-600">${formatMoney(l.paid || 0)}</td><td class="px-3 py-2 text-center font-bold text-gray-700">${l.paymentCount || 0}</td><td class="px-3 py-2 text-right font-mono font-bold ${isPaidOff ? 'text-green-600' : 'text-red-600'}">${formatMoney(bal)}</td><td class="px-3 py-2 text-center flex gap-1 justify-center">${isPaidOff ? `<button onclick="window.archiveLoan(${idx})" class="text-gray-500 hover:text-gray-800" title="Archive (Remove from Active)"><i data-lucide="folder-check" class="w-3.5 h-3.5"></i></button>` : `<button onclick="window.editLoan(${idx})" class="text-blue-400 hover:text-blue-600"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>`}<button onclick="window.removeLoan(${idx})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></td></tr>`;
            }).join(''); 
            if(window.lucide) lucide.createIcons(); 
        }
        window.editLoan = (idx) => { const loan = selectedOTLStaff.activeLoans[idx]; document.getElementById('new-loan-desc').value = loan.description; document.getElementById('new-loan-amount').value = loan.total; document.getElementById('new-loan-date').value = loan.dateAdded; document.getElementById('new-loan-start').value = loan.startDate; editingLoanIndex = idx; document.getElementById('loan-form-title').innerText = "Edit Loan Details"; document.getElementById('btn-save-loan').innerText = "Update Loan"; document.getElementById('btn-cancel-loan').classList.remove('hidden'); };
        window.cancelLoanEdit = () => { editingLoanIndex = -1; document.getElementById('new-loan-desc').value = ""; document.getElementById('new-loan-amount').value = ""; document.getElementById('new-loan-date').value = ""; document.getElementById('new-loan-start').value = ""; document.getElementById('loan-form-title').innerText = "Add New Loan"; document.getElementById('btn-save-loan').innerText = "Add Loan"; document.getElementById('btn-cancel-loan').classList.add('hidden'); }
        window.saveLoanRecord = async () => { const desc = document.getElementById('new-loan-desc').value; const amt = parseFloat(document.getElementById('new-loan-amount').value); const dateAdded = document.getElementById('new-loan-date').value; const startDate = document.getElementById('new-loan-start').value; if (!desc || !amt || !dateAdded || !startDate) return alert("Please fill all loan fields."); const loanData = { description: desc, total: amt, dateAdded: dateAdded, startDate: startDate, paid: (editingLoanIndex > -1) ? selectedOTLStaff.activeLoans[editingLoanIndex].paid : 0, paymentCount: (editingLoanIndex > -1) ? selectedOTLStaff.activeLoans[editingLoanIndex].paymentCount : 0 }; if(editingLoanIndex > -1) { selectedOTLStaff.activeLoans[editingLoanIndex] = loanData; } else { selectedOTLStaff.activeLoans.push(loanData); } selectedOTLStaff.lastModified = new Date().toISOString(); await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(selectedOTLStaff)); renderLoanTable(); window.cancelLoanEdit(); window.renderOTLOverview(); };
        window.addLoan = () => window.saveLoanRecord();
        window.printLoanStatement = () => { if(!selectedOTLStaff) return; const loans = selectedOTLStaff.activeLoans || []; const printW = window.open('', '', 'height=600,width=800'); printW.document.write('<html><head><title>Loan Statement</title><link href="https://cdn.tailwindcss.com" rel="stylesheet"></head><body class="bg-white p-8 font-sans">'); printW.document.write(`<div class="max-w-3xl mx-auto border p-8"><div class="text-center border-b pb-4 mb-6"><h1 class="text-2xl font-bold uppercase text-gray-800">Neerada School</h1><p class="text-sm text-gray-500">Loan Statement</p></div><div class="flex justify-between mb-6"><div><p class="text-xs text-gray-500 uppercase">Employee Name</p><p class="font-bold text-lg">${selectedOTLStaff.name}</p></div><div class="text-right"><p class="text-xs text-gray-500 uppercase">Date</p><p class="font-bold">${new Date().toLocaleDateString()}</p></div></div><h3 class="font-bold text-gray-700 mb-2 border-b pb-1">Active Loans</h3><table class="w-full text-sm mb-8 border-collapse border border-gray-200"><thead class="bg-gray-50"><tr><th class="border p-2 text-left">Description</th><th class="border p-2 text-center">Date Added</th><th class="border p-2 text-right">Total Amount</th><th class="border p-2 text-right">Paid</th><th class="border p-2 text-right">Balance</th></tr></thead><tbody>${loans.map(l => `<tr><td class="border p-2">${l.description}</td><td class="border p-2 text-center">${l.dateAdded}</td><td class="border p-2 text-right">${formatMoney(l.total)}</td><td class="border p-2 text-right">${formatMoney(l.paid||0)}</td><td class="border p-2 text-right font-bold">${formatMoney(l.total - (l.paid||0))}</td></tr>`).join('') || '<tr><td colspan="5" class="border p-4 text-center">No active loans</td></tr>'}</tbody></table><div class="mt-8 text-xs text-gray-400 text-center">Generated by Neerada Payroll System</div></div>`); printW.document.write('</body></html>'); printW.document.close(); setTimeout(() => { printW.focus(); printW.print(); }, 500); };
        window.removeLoan = async (idx) => { if (!confirm("Delete this loan record?")) return; selectedOTLStaff.activeLoans.splice(idx, 1); selectedOTLStaff.lastModified = new Date().toISOString(); await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(selectedOTLStaff)); renderLoanTable(); };
        window.archiveLoan = async (idx) => { 
            if (!confirm("Archive this completed loan? It will be removed from the active list.")) return; 
            const loan = selectedOTLStaff.activeLoans[idx];
            selectedOTLStaff.archivedLoans = selectedOTLStaff.archivedLoans || [];
            selectedOTLStaff.archivedLoans.push(loan);
            selectedOTLStaff.activeLoans.splice(idx, 1); 
            selectedOTLStaff.lastModified = new Date().toISOString(); 
            await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(selectedOTLStaff)); 
            renderLoanTable(); 
            window.renderOTLOverview(); 
        };
        window.saveOTDetails = async () => { const m = document.getElementById('otl-month').value; const y = document.getElementById('otl-year').value; const key = `${y}-${m}`; if (!selectedOTLStaff.payrollHistory) selectedOTLStaff.payrollHistory = {}; if (!selectedOTLStaff.payrollHistory[key]) selectedOTLStaff.payrollHistory[key] = createInitialState(selectedOTLStaff.department); const pd = selectedOTLStaff.payrollHistory[key]; if (selectedOTLStaff.department === 'English') { pd.otHours = parseFloat(document.getElementById('otl-hours').value) || 0; pd.otRate = parseFloat(document.getElementById('otl-rate').value) || 0; } else { pd.overtimeAmount = parseFloat(document.getElementById('otl-amount').value) || 0; } selectedOTLStaff.lastModified = new Date().toISOString(); await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(selectedOTLStaff)); alert("Overtime updated for " + m + " " + y); if (selectedEmployee && selectedEmployee.id === selectedOTLStaff.id) loadPeriodData(); window.renderOTLOverview(); };
        window.saveLoanPayment = async () => { 
            const m = document.getElementById('otl-month').value; 
            const y = document.getElementById('otl-year').value; 
            const key = `${y}-${m}`; 
            
            // Clean input from commas
            const rawVal = document.getElementById('loan-repay-amount').value.replace(/,/g, '');
            const newPayment = parseFloat(rawVal) || 0; 
            
            // ROBUST REFATCH: Ensure we are working on the latest DB object to prevent ghost saves
            const freshStaff = await transact(STORE_EMPLOYEES, 'readonly', s => s.get(selectedOTLStaff.id));
            if(freshStaff) {
                 selectedOTLStaff = freshStaff; // Update global ref
                 // Re-init arrays if missing on fresh object
                 if (!selectedOTLStaff.payrollHistory) selectedOTLStaff.payrollHistory = {}; 
                 if (!selectedOTLStaff.payrollHistory[key]) selectedOTLStaff.payrollHistory[key] = createInitialState(selectedOTLStaff.department); 
                 if (!selectedOTLStaff.activeLoans) selectedOTLStaff.activeLoans = [];
            }

            const ph = selectedOTLStaff.payrollHistory[key]; 
            const oldPayment = ph.loanDeduction || 0; 
            ph.loanDeduction = newPayment; 
            
            const difference = newPayment - oldPayment; 
            
            if (selectedOTLStaff.activeLoans.length > 0) { 
                let countChange = 0; 
                // Logic update: If value is entered (>0) and wasn't there, count as payment.
                // If it was there and becomes 0, decrement.
                if (oldPayment === 0 && newPayment > 0) countChange = 1; 
                else if (oldPayment > 0 && newPayment === 0) countChange = -1; 
                
                // Get the loan we are paying towards (first one)
                let loan = selectedOTLStaff.activeLoans[0];
                
                if (difference !== 0 || countChange !== 0) { 
                    loan.paid = (loan.paid || 0) + difference; 
                    loan.paymentCount = Math.max(0, (loan.paymentCount || 0) + countChange); 
                }
                
                // Save Loan Description to Payroll History for Payslip
                ph.loanDesc = loan.description;
            } 
            
            selectedOTLStaff.lastModified = new Date().toISOString(); 
            await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(selectedOTLStaff)); 
            
            // Update global array to reflect changes immediately in other views
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());

            alert("Loan Deduction applied. Payslip updated. Balances adjusted."); 
            renderLoanTable(); 
            if (selectedEmployee && selectedEmployee.id === selectedOTLStaff.id) loadPeriodData(); 
            window.renderOTLOverview(); 
        };

        // --- BULK COPY LOAN PAYMENTS ---
        window.bulkCopyLoanPayments = async () => {
            const m = document.getElementById('otl-month').value;
            const y = document.getElementById('otl-year').value;
            const currKey = `${y}-${m}`;

            // Determine previous month
            const currMIdx = MONTHS.indexOf(m);
            let prevMIdx = currMIdx - 1;
            let prevYr = parseInt(y);
            if (prevMIdx < 0) { prevMIdx = 11; prevYr--; }
            const prevM = MONTHS[prevMIdx];
            const prevKey = `${prevYr}-${prevM}`;

            if (!confirm(`Copy loan payments from ${prevM} ${prevYr} to ${m} ${y}?\n\nThis will apply previous payment amounts to all active loans for the current month.\n\n(Smart Feature: Payments exceeding remaining balance will be automatically capped)`)) return;

            let updatedCount = 0;
            let skippedCount = 0;
            let cappedCount = 0;

            for (const emp of employees) {
                // Check if employee has active loans
                if (emp.activeLoans && emp.activeLoans.length > 0) {
                    const loan = emp.activeLoans[0]; // Assuming payments go to the first loan
                    
                    // Check if employee has data for previous month
                    if (emp.payrollHistory && emp.payrollHistory[prevKey]) {
                        const prevPayment = parseFloat(emp.payrollHistory[prevKey].loanDeduction || 0);

                        if (prevPayment > 0) {
                            // Initialize current month history if missing
                            if (!emp.payrollHistory) emp.payrollHistory = {};
                            if (!emp.payrollHistory[currKey]) emp.payrollHistory[currKey] = createInitialState(emp.department);

                            const currHist = emp.payrollHistory[currKey];

                            // Skip if already paid this month
                            if (parseFloat(currHist.loanDeduction || 0) > 0) {
                                skippedCount++;
                                continue;
                            }

                            // Calculate smart payment
                            const balance = parseFloat(loan.total) - parseFloat(loan.paid || 0);
                            let paymentToApply = prevPayment;
                            
                            if (paymentToApply > balance) {
                                paymentToApply = balance;
                                cappedCount++;
                            }

                            // Apply Payment
                            currHist.loanDeduction = paymentToApply;
                            currHist.loanDesc = loan.description; // Ensure description is copied

                            // Update Loan Record
                            loan.paid = (loan.paid || 0) + paymentToApply;
                            loan.paymentCount = (loan.paymentCount || 0) + 1;

                            emp.lastModified = new Date().toISOString();
                            await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
                            updatedCount++;
                        }
                    }
                }
            }

            // Refresh Data
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            window.renderOTLOverview();
            
            // Show Summary
            alert(`Bulk Copy Complete!\n\n- Updated: ${updatedCount} staff\n- Auto-Capped to Balance: ${cappedCount} staff\n- Skipped (Already Paid): ${skippedCount} staff`);
        };
        
        // --- NEW BULK IMPORT FUNCTIONS ---
        window.downloadTemplate = (dept) => {
            const m = document.getElementById('bulk-import-month').value;
            const y = document.getElementById('bulk-import-year').value;
            if(!dept) return alert("Select a department.");
            
            const cfg = departmentConfigs[dept];
            if (!cfg) return alert("Configuration not found for " + dept);
            
            // Build Headers: Name + Earnings + Deductions + Calculated Columns + Notes
            // Added Totals and Net Pay as requested for template structure
            let headers = ["Employee Name", ...cfg.earnings, ...cfg.deductions, "Total Earnings", "Total Deductions", "Net Pay", "Notes"];
            
            // Get employees for this department to pre-fill
            const deptEmps = employees.filter(e => e.department === dept).sort((a,b) => a.name.localeCompare(b.name));
            
            // Build CSV Content
            let csvContent = "data:text/csv;charset=utf-8,\ufeff" + headers.join(",") + "\n";
            
            deptEmps.forEach(emp => {
                // Pre-fill name, leave others 0/empty
                // We create an array of 0s for earnings/deductions
                const emptyVals = new Array(cfg.earnings.length + cfg.deductions.length).fill(0);
                // Add 0s for Total Earnings, Total Deductions, Net Pay, and empty string for Notes
                const row = [`"${emp.name}"`, ...emptyVals, 0, 0, 0, ""];
                csvContent += row.join(",") + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Payroll_Template_${dept}_${m}_${y}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.handleBulkCSVPayslipUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            const m = document.getElementById('bulk-import-month').value;
            const y = document.getElementById('bulk-import-year').value;
            const key = `${y}-${m}`;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n').filter(r => r.trim());
                if (rows.length < 2) return alert("Invalid CSV format.");
                
                // Parse Headers
                // Remove quotes from headers if present
                const headers = rows[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
                
                // Identify columns
                const nameIdx = headers.indexOf("Employee Name");
                const notesIdx = headers.indexOf("Notes");
                
                if (nameIdx === -1) return alert("CSV must have 'Employee Name' column.");
                
                let updatedCount = 0;
                
                for (let i = 1; i < rows.length; i++) {
                    // Split row handling commas inside quotes is tricky, but for simplicity assuming standard export format
                    // A simple regex split or standard split if names don't contain commas
                    // Better regex for CSV: /,(?=(?:(?:[^"]*"){2})*[^"]*$)/
                    const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                    
                    if (cols.length < headers.length) continue;
                    
                    const empName = cols[nameIdx];
                    const emp = employees.find(e => e.name === empName);
                    
                    if (emp) {
                        if (!emp.payrollHistory) emp.payrollHistory = {};
                        // Init state if empty
                        if (!emp.payrollHistory[key]) emp.payrollHistory[key] = createInitialState(emp.department);
                        
                        const state = emp.payrollHistory[key];
                        
                        // Loop through headers to map values to state
                        headers.forEach((h, index) => {
                            if (index !== nameIdx && index !== notesIdx) {
                                // Assume it's a numeric field
                                if (state.hasOwnProperty(h)) {
                                    state[h] = parseFloat(cols[index]) || 0;
                                }
                            }
                        });
                        
                        if (notesIdx !== -1 && cols[notesIdx]) {
                            state.notes = cols[notesIdx];
                        }
                        
                        // Save
                        emp.lastModified = new Date().toISOString();
                        await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
                        updatedCount++;
                    }
                }
                
                employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
                window.updateDashboardStats();
                if (selectedEmployee) loadPeriodData();
                alert(`Bulk Upload Complete. Updated ${updatedCount} records for ${m} ${y}.`);
                input.value = ''; // Reset file input
            };
            reader.readAsText(file);
        };

        window.goBack = () => { selectedEmployee = null; document.getElementById('editor-area').classList.add('hidden'); document.getElementById('empty-state').classList.remove('hidden'); };
        window.openSettings = () => { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-modal').classList.add('flex'); };
        window.closeSettings = () => { document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); };
        window.bulkCopyPrevious = async () => { const m = document.getElementById('bulk-month').value; const y = document.getElementById('bulk-year').value; if(!m || !y) return; const currMIdx = MONTHS.indexOf(m); let prevMIdx = currMIdx - 1; let prevYr = parseInt(y); if (prevMIdx < 0) { prevMIdx = 11; prevYr--; } const prevM = MONTHS[prevMIdx]; if(!confirm(`Copy data from ${prevM} ${prevYr} to ${m} ${y} for ALL employees?\n\nWarning: This will overwrite existing data for ${m} ${y}.`)) return; const prevKey = `${prevYr}-${prevM}`; const currKey = `${y}-${m}`; let count = 0; for (const emp of employees) { if (emp.payrollHistory && emp.payrollHistory[prevKey]) { if (!emp.payrollHistory) emp.payrollHistory = {}; emp.payrollHistory[currKey] = JSON.parse(JSON.stringify(emp.payrollHistory[prevKey])); emp.lastModified = new Date().toISOString(); await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp)); count++; } } employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); window.updateDashboardStats(); if (selectedEmployee) loadPeriodData(); alert(`Success! Copied data for ${count} employees.`); };
        window.bulkSaveMonthData = async () => { const m = document.getElementById('bulk-month').value; const y = document.getElementById('bulk-year').value; if(!m || !y) return; const currKey = `${y}-${m}`; if(!confirm(`Save/Generate payroll data for ${m} ${y} for ALL employees?\n\nThis will create records using Department Defaults for any staff who don't have data yet.`)) return; let count = 0; for (const emp of employees) { if (!emp.payrollHistory) emp.payrollHistory = {}; if (!emp.payrollHistory[currKey]) { emp.payrollHistory[currKey] = createInitialState(emp.department); emp.lastModified = new Date().toISOString(); await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp)); count++; } } employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); window.updateDashboardStats(); if (selectedEmployee) loadPeriodData(); alert(`Success! Generated default records for ${count} employees.\n(Employees with existing data were not changed)`); };
        window.openPrintSettings = () => { if(!selectedEmployee) return; document.getElementById('print-modal').classList.remove('hidden'); document.getElementById('print-modal').classList.add('flex'); };
        window.closePrintSettings = () => { document.getElementById('print-modal').classList.add('hidden'); };
        window.bulkResetPayroll = async () => { const yr = document.getElementById('editor-year').value; const mn = document.getElementById('editor-month').value; const targetStr = currentFilter.department === 'All' ? 'ALL Staff' : currentFilter.department; if(!confirm(`RESET payroll data for ${targetStr} for ${mn} ${yr}? This cannot be undone.`)) return; const key = `${yr}-${mn}`; let count = 0; const targetEmployees = currentFilter.department === 'All' ? employees : employees.filter(e => e.department === currentFilter.department); for(const emp of targetEmployees) { if(emp.payrollHistory && emp.payrollHistory[key]) { delete emp.payrollHistory[key]; await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp)); count++; } } employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); window.updateDashboardStats(); if(selectedEmployee) loadPeriodData(); alert(`Reset data for ${count} employees.`); };
        window.deleteAllEmployeesInFilter = async () => { const targetStr = currentFilter.department === 'All' ? 'ALL Staff' : currentFilter.department; if(!confirm(`DELETE ${targetStr}? This will remove employees and all their history permanently.`)) return; if(!confirm(`Are you absolutely sure you want to delete ${targetStr}?`)) return; const targetEmployees = currentFilter.department === 'All' ? employees : employees.filter(e => e.department === currentFilter.department); for(const emp of targetEmployees) { await transact(STORE_EMPLOYEES, 'readwrite', s => s.delete(emp.id)); } employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); selectedEmployee = null; document.getElementById('editor-area').classList.add('hidden'); document.getElementById('empty-state').classList.remove('hidden'); renderEmployeeList(); renderDeptSidebar(); window.updateDashboardStats(); alert("Deletion complete."); };
        window.downloadCSVTemplate = () => { const headers = ["No", "ID", "Name", "Gender", "Department", "Position", "LAK Account", "USD Account", "Email", "WhatsApp"]; const csvContent = "data:text/csv;charset=utf-8," + headers.join(","); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "staff_import_template.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
        
        // --- UPDATED EXPORT FUNCTION WITH AUTO-CLEANING FOR GS DEPARTMENTS ---
        window.exportData = async () => { 
            const emp = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll()); 
            const hist = await transact(STORE_HISTORY, 'readonly', s => s.getAll()); 
            const cfg = await transact(STORE_CONFIG, 'readonly', s => s.getAll()); 
            
            // --- DATA SANITIZATION FOR EXPORT ---
            const restrictedGSFields = [
                "ດຸໝັ່ນຄົ້ນຄວ້າ&ພັດທະນາການສອນການສອນ (ຮູ້ນໍາໃຊ້ເຕັກນິກເພື່ອເຮັດໃຫ້ ນຮ ມັກຮຽນ)",
                "ນຳໃຊ້ສື່ການສອນ/ແຕ່ງບົດສອນ/ຕິດຕາມພັດທະນາການ ນຮ.ຫ້າວຫັນໃນການປະກອບສ່ວນໃນວຽກອື່ນໆຂອງໂຮງຮຽນ",
                "ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ໃສ່ໃຈນຳ ນັກຮຽນ",
                "ຄວາມຮັບຜິດຊອບໃນຫ້ອງຮຽນ : ທຸກໆຢ່າງ",
                "ນະໂຍບາຍອື່ນໆ",
                "ໃບປະກາດ: ປຕີ (ສອງແສນຫ້າສິບ) ຊັ້ນສູງ (ສອງແສນ) ຊັ້ນກາງ (ໜຶ່ງແສນຫ້າສິບ)",
                "ຄູປະຈຳຫ້ອງ/ຄູປະຈຳຫ້ອງສະໝຸດ/ຄູປະຈຳເດີ່ນກິລາ",
                "ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ນຮ/ໃສ່ໃຈນຳນັກຮຽນ",
                "ເລີ້ມຕົ້ນ"
            ];

            const isGSDepartment = (deptName) => {
                if (!deptName) return false;
                if (GS_DEPTS.includes(deptName)) return true;
                if (ACADEMIC_DEPTS.includes(deptName) || deptName === 'English') return false;
                const lower = deptName.toLowerCase();
                return lower.includes('admin') || lower.includes('secretary') || lower.includes('cook') || lower.includes('driver') || lower.includes('repair') || lower.includes('guard') || lower.includes('cleaner') || lower.includes('general') || lower.includes('account');
            };

            // 1. Clean Configuration (Create copy to not affect live app state during export)
            const cleanConfig = cfg.map(c => {
                if (isGSDepartment(c.name)) {
                    const newC = JSON.parse(JSON.stringify(c));
                    newC.earnings = newC.earnings.filter(f => !restrictedGSFields.includes(f));
                    return newC;
                }
                return c;
            });

            // 2. Clean Employee History (Create copy)
            const cleanEmployees = emp.map(e => {
                if (isGSDepartment(e.department)) {
                    const newE = JSON.parse(JSON.stringify(e));
                    if (newE.payrollHistory) {
                        Object.keys(newE.payrollHistory).forEach(key => {
                            restrictedGSFields.forEach(field => {
                                delete newE.payrollHistory[key][field];
                            });
                        });
                    }
                    return newE;
                }
                return e;
            });

            const data = { employees: cleanEmployees, history: hist, config: cleanConfig, timestamp: Date.now() }; 
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `neerada_backup_${new Date().toISOString().split('T')[0]}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
        };

        window.importData = (input) => { 
            const file = input.files[0]; if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = async (e) => { 
                try { 
                    const data = JSON.parse(e.target.result); 
                    
                    let importedConfig = data.config || data.departmentConfigs; 
                    let importedEmployees = data.employees; 
                    let importedHistory = data.history || data.history_logs; 
                    if (!importedEmployees) throw new Error("Invalid backup: Missing employees data."); 
                    if (importedConfig && !Array.isArray(importedConfig)) { 
                        importedConfig = Object.entries(importedConfig).map(([name, cfg]) => ({ name, ...cfg })); 
                    } 
                    if (!importedConfig) { 
                        if(!confirm("Backup is missing configuration data. Import employees only?")) return; 
                        importedConfig = []; 
                    } else { 
                        if (!confirm(`Restore backup from ${new Date(data.timestamp || Date.now()).toLocaleDateString()}? This will overwrite current data.`)) return; 
                    } 

                    // --- DATA SANITIZATION START (IMPORT) ---
                    const fieldsToRemoveFromGS = [
                        "ດຸໝັ່ນຄົ້ນຄວ້າ&ພັດທະນາການສອນການສອນ (ຮູ້ນໍາໃຊ້ເຕັກນິກເພື່ອເຮັດໃຫ້ ນຮ ມັກຮຽນ)",
                        "ນຳໃຊ້ສື່ການສອນ/ແຕ່ງບົດສອນ/ຕິດຕາມພັດທະນາການ ນຮ.ຫ້າວຫັນໃນການປະກອບສ່ວນໃນວຽກອື່ນໆຂອງໂຮງຮຽນ",
                        "ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ໃສ່ໃຈນຳ ນັກຮຽນ",
                        "ຄວາມຮັບຜິດຊອບໃນຫ້ອງຮຽນ : ທຸກໆຢ່າງ",
                        "ນະໂຍບາຍອື່ນໆ",
                        "ໃບປະກາດ: ປຕີ (ສອງແສນຫ້າສິບ) ຊັ້ນສູງ (ສອງແສນ) ຊັ້ນກາງ (ໜຶ່ງແສນຫ້າສິບ)",
                        "ຄູປະຈຳຫ້ອງ/ຄູປະຈຳຫ້ອງສະໝຸດ/ຄູປະຈຳເດີ່ນກິລາ",
                        "ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ນຮ/ໃສ່ໃຈນຳນັກຮຽນ",
                        "ເລີ້ມຕົ້ນ"
                    ];

                    const isGSDepartment = (deptName) => {
                        if (!deptName) return false;
                        if (GS_DEPTS.includes(deptName)) return true;
                        if (ACADEMIC_DEPTS.includes(deptName) || deptName === 'English') return false;
                        const lower = deptName.toLowerCase();
                        return lower.includes('admin') || lower.includes('secretary') || lower.includes('cook') || lower.includes('driver') || lower.includes('repair') || lower.includes('guard') || lower.includes('cleaner') || lower.includes('general') || lower.includes('account');
                    };

                    // 1. Clean Configuration
                    if (importedConfig) {
                        importedConfig.forEach(c => {
                            if (isGSDepartment(c.name)) {
                                c.earnings = c.earnings.filter(f => !fieldsToRemoveFromGS.includes(f));
                            }
                        });
                    }

                    // 2. Clean Employee History
                    if (importedEmployees) {
                        importedEmployees.forEach(emp => {
                            if (isGSDepartment(emp.department)) {
                                if (emp.payrollHistory) {
                                    Object.keys(emp.payrollHistory).forEach(key => {
                                        const entry = emp.payrollHistory[key];
                                        fieldsToRemoveFromGS.forEach(field => {
                                            delete entry[field];
                                        });
                                    });
                                }
                                if (emp.savedPayroll) {
                                    fieldsToRemoveFromGS.forEach(field => {
                                        delete emp.savedPayroll[field];
                                    });
                                }
                            }
                        });
                    }
                    // --- DATA SANITIZATION END ---

                    const defaultGSConfigs = {}; 
                    for (const d of GS_DEPTS) { 
                        let earnings = [...laoEarningsStruct]; 
                        let deductions = [...defaultDeductions]; 
                        if (d.includes('Accounts')) { earnings = ['Basic Pay (USD)', 'Exchange Rate (LAK)', 'ເງີນເດືອນພື້ນຖານ', 'ສະສົມປີຜ່ານມາ', 'ເພີ້ມປະຈຳປີ 2025-2026', 'ບໍລິຫານຫ້ອງການ/ບັນຊີ', 'ດຸໝັ່ນມາການ (ບໍ່ຂາດການ)', 'ພົວພັນວຽກທາງນອກ-ພາຍໃນ', 'ບັນຊີ ການເງີນວຽກອື່ນໆຂອງໂຮງຮຽນ']; } else if (d.includes('Invitational Teachers')) { earnings = ['ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)', 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)', 'ເງີນເດືອນ']; } 
                        defaultGSConfigs[d] = { name: d, earnings, deductions }; 
                    } 
                    const importedDeptNames = new Set(importedConfig.map(c => c.name)); 
                    for (const gsDept of GS_DEPTS) { if (!importedDeptNames.has(gsDept)) { importedConfig.push(defaultGSConfigs[gsDept]); } } 
                    
                    if (importedConfig.length > 0) { 
                        await transact(STORE_CONFIG, 'readwrite', s => s.clear()); 
                        // PATCH: Ensure Lao fields exist for standard departments
                        for (const c of importedConfig) {
                            if (c.name !== 'English' && !c.name.includes('Accounts') && !c.name.includes('Invitational') && !isGSDepartment(c.name)) {
                                // Re-enforce standard order for standard ACADEMIC departments only
                                let newEarnings = [];
                                const existingEarningsSet = new Set(c.earnings);
                                laoEarningsStruct.forEach(field => {
                                    newEarnings.push(field);
                                    existingEarningsSet.delete(field);
                                });
                                existingEarningsSet.forEach(field => {
                                    newEarnings.push(field);
                                });
                                c.earnings = newEarnings;
                            }
                            await transact(STORE_CONFIG, 'readwrite', s => s.put(c));
                        }
                        departmentConfigs = {}; 
                        importedConfig.forEach(c => departmentConfigs[c.name] = { earnings: c.earnings, deductions: c.deductions }); 
                    } 
                    await transact(STORE_EMPLOYEES, 'readwrite', s => s.clear()); 
                    for (const em of importedEmployees) { if(!em.payrollHistory) em.payrollHistory = {}; if(!em.savedPayroll) em.savedPayroll = {}; await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(em)); } 
                    employees = importedEmployees; 
                    await transact(STORE_HISTORY, 'readwrite', s => s.clear()); 
                    if (importedHistory) { for (const h of importedHistory) await transact(STORE_HISTORY, 'readwrite', s => s.put(h)); history = importedHistory; } 
                    alert("Restore successful! Data cleaned and sanitized. Reloading..."); 
                    // PERSISTENCE FIX: Ensure we stay in app mode
                    localStorage.setItem('neerada_current_view', 'app');
                    window.location.reload(); 
                } catch (err) { alert("Error importing data: " + err.message); console.error("Import Error Details:", err); } 
            }; reader.readAsText(file); input.value = ''; 
        };
        window.openGlobalArchives = () => {
            const list = document.getElementById('global-archive-list');
            let rows = "";
            let hasData = false;
            employees.forEach(emp => {
                if(emp.archivedLoans && emp.archivedLoans.length > 0) {
                    hasData = true;
                    emp.archivedLoans.forEach(l => {
                        rows += `<tr class="border-b border-gray-50"><td class="px-4 py-3 font-medium text-gray-800">${emp.name}</td><td class="px-4 py-3 text-gray-500 text-xs">${emp.department}</td><td class="px-4 py-3 text-gray-700">${l.description}</td><td class="px-4 py-3 text-center text-xs text-gray-500">${l.dateAdded}</td><td class="px-4 py-3 text-right font-mono">${formatMoney(l.total)}</td><td class="px-4 py-3 text-center"><span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-[10px] font-bold">Paid Off</span></td></tr>`;
                    });
                }
            });
            list.innerHTML = hasData ? rows : `<tr><td colspan="6" class="p-6 text-center text-gray-400">No archived loans found.</td></tr>`;
            document.getElementById('global-archive-modal').classList.remove('hidden');
            if(window.lucide) lucide.createIcons();
        };

        window.toggleBankFields = () => { const dept = document.getElementById('form-department').value; const usdField = document.getElementById('bank-usd-container'); if (dept === 'English' || dept.includes('Accounts')) { usdField.classList.remove('hidden'); } else { usdField.classList.add('hidden'); } };
        window.bulkSavePayroll = () => window.openSaveHistoryModal();
        
        window.onload = function() { 
            lucide.createIcons();
            // Load logo immediately for landing page
            const savedLogo = localStorage.getItem('neerada_school_logo');
            if(savedLogo) {
                 // Logic to update landing page DOM immediately
                 const landingLogo = document.getElementById('landing-custom-logo');
                 const landingIcon = document.getElementById('landing-logo-container');
                 if(landingLogo && landingIcon) {
                     landingLogo.src = savedLogo;
                     landingLogo.classList.remove('hidden');
                     landingIcon.classList.add('hidden');
                 }
                 // Also update preview/header just in case
                 const headerLogo = document.getElementById('header-custom-logo');
                 if(headerLogo) {
                     headerLogo.src = savedLogo;
                     headerLogo.classList.remove('hidden');
                 }
                 const prevLogo = document.getElementById('prev-school-logo');
                 if (prevLogo) {
                     prevLogo.src = savedLogo;
                     prevLogo.classList.remove('hidden');
                 }
                 const favEl = document.getElementById('app-favicon');
                 const appleEl = document.getElementById('app-apple-touch-icon');
                 if (favEl) favEl.href = savedLogo;
                 if (appleEl) appleEl.href = savedLogo;
            }

            // Check Lock State Immediately
            if (localStorage.getItem('neerada_locked') === 'true') {
                window.showLockScreen();
                return; // Stop view transitions
            }

            // Restore View State (Fixed) - REPLACED WITH ALWAYS LANDING PAGE
            // Clear view state to ensure next reload is also landing
            localStorage.removeItem('neerada_current_view'); 
            
            // Stay on landing (default)
            // Auto-exit welcome modal after 4 seconds
            setTimeout(() => {
                const wm = document.getElementById('welcome-modal');
                if(wm && !wm.classList.contains('hidden') && !wm.classList.contains('exiting')) {
                        window.closeWelcome();
                }
            }, 4000);
        };
    </script>
</body>
</html>